<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Parameter Optimizer</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <style>
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --bg-input: #252d3d;
            --text-primary: #e7e9ea;
            --text-secondary: #71767b;
            --accent: #1d9bf0;
            --accent-hover: #1a8cd8;
            --success: #00ba7c;
            --warning: #ffad1f;
            --danger: #f4212e;
            --border: #2f3336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        header {
            background: #111625;
            padding: 0.4rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header img {
            height: 44px;
        }

        header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 400;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #1d9bf0, #00ba7c);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 1.5rem;
            align-items: start;
        }

        .panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .panel h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select,
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-input);
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            background: var(--bg-input);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(29, 155, 240, 0.1);
            color: var(--accent);
            border: 1px solid rgba(29, 155, 240, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(29, 155, 240, 0.2);
            border-color: var(--accent);
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card.optimizing {
            border-color: var(--warning);
        }

        .result-card.complete {
            border-color: var(--success);
        }

        .result-card.error {
            border-color: var(--danger);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .symbol-badge {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.optimizing {
            background: rgba(255, 173, 31, 0.2);
            color: var(--warning);
        }

        .status-badge.complete {
            background: rgba(0, 186, 124, 0.2);
            color: var(--success);
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-input);
            border-radius: 3px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            transition: width 0.3s ease;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .metric {
            background: var(--bg-input);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .metric-value.positive {
            color: var(--success);
        }

        .metric-value.negative {
            color: var(--danger);
        }

        .params-display {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: 8px;
        }

        .param {
            flex: 1;
            text-align: center;
        }

        .param-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .param-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .log-container {
            margin-top: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            font-size: 0.75rem;
            padding: 0.25rem 0;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .log-entry.info {
            color: var(--accent);
        }

        .log-entry.success {
            color: var(--success);
        }

        .log-entry.error {
            color: var(--danger);
        }

        .log-entry.warning {
            color: var(--warning);
        }

        .log-tabs {
            display: flex;
            gap: 0;
            margin-top: 1rem;
            margin-bottom: 0;
        }

        .log-tab {
            padding: 0.5rem 1.25rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-right: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .log-tab:first-child {
            border-radius: 8px 0px 0px 8px;
        }

        .log-tab:last-child {
            border-radius: 0px 8px 8px 0px;
            border-right: 1px solid var(--border);
        }

        .log-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .analysis-container {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 0px 8px 8px 8px;
            padding: 1rem;
            max-height: 1000px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .analysis-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }

        .connection-dot.connected {
            background: var(--success);
        }

        /* GPU/CPU Filter and Icons */
        .filter-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .filter-checkbox input {
            width: 14px;
            height: 14px;
            accent-color: var(--accent);
        }

        .gpu-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
            flex-shrink: 0;
            letter-spacing: 0.3px;
        }

        .gpu-icon.gpu {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
        }

        .gpu-icon.cpu {
            background: var(--bg-input);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* DB Cache Icon */
        .db-cache-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            margin-left: 8px;
            vertical-align: middle;
            animation: db-pulse 2s ease-in-out infinite;
        }

        .db-cache-icon.loading {
            background: var(--bg-input);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            animation: none;
        }

        .db-cache-icon.no-cache {
            display: none;
        }

        @keyframes db-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .symbol-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .symbol-input-wrapper input {
            flex: 1;
        }

        .cache-tooltip {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .cache-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 12px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid var(--border);
        }

        .clear-all-cache-progress {
            display: none;
            margin-top: 6px;
            padding: 7px 8px;
            border-radius: 8px;
            border: 1px solid rgba(29, 155, 240, 0.3);
            background: rgba(29, 155, 240, 0.08);
        }

        .clear-all-cache-progress.active {
            display: block;
        }

        .clear-all-cache-progress-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.68rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            gap: 8px;
        }

        .clear-all-cache-progress-row span:first-child {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 185px;
        }

        .clear-all-cache-progress .progress-bar {
            margin: 0;
            height: 5px;
        }

        /* History Panel Styles */
        .history-panel {
            height: fit-content;
            min-height: 800px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .history-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: var(--accent);
        }

        .history-item-content {
            flex: 1;
            cursor: pointer;
        }

        .history-item-content:hover {
            opacity: 0.9;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 0.8rem;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            opacity: 1;
            color: var(--danger);
        }

        .delete-all-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.35rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            transition: all 0.2s;
            margin-left: auto;
        }

        .delete-all-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(244, 33, 46, 0.1);
        }

        .history-item.selected {
            border-color: var(--success);
            background: rgba(0, 186, 124, 0.1);
        }

        .history-symbol {
            font-weight: 700;
            color: var(--accent);
            font-size: 1rem;
        }

        .history-date {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .history-params {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .history-param {
            background: var(--bg-dark);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .history-param.timing {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.4rem;
        }

        .history-score {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--success);
            margin-top: 0.25rem;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-bottom: 1rem;
            width: 100%;
        }

        .refresh-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .sort-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.35rem 0.6rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
            position: relative;
        }

        .sort-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a1f2e;
            color: #e7e9ea;
            border: 1px solid #2f3336;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.75rem;
            white-space: normal;
            text-align: center;
            z-index: 1000;
            pointer-events: none;
            max-width: 260px;
        }

        .sort-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .sort-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8rem;
            margin-bottom: 0.75rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        /* Global Progress Bar */
        .global-progress {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: none;
        }

        .global-progress.active {
            display: block;
        }

        .global-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .global-progress-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .global-progress-stats {
            display: flex;
            gap: 1.5rem;
            font-size: 0.875rem;
        }

        .global-progress-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .global-progress-stat-label {
            color: var(--text-secondary);
        }

        .global-progress-stat-value {
            color: var(--accent);
            font-weight: 600;
            font-family: monospace;
        }

        .global-progress-bar {
            height: 12px;
            background: var(--bg-input);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .global-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            transition: width 0.3s ease;
            position: relative;
        }

        /* Indeterminate loading state - shows animated bar during data loading */
        .global-progress-fill.loading {
            width: 30% !important;
            animation: loading-pulse 1.5s ease-in-out infinite;
        }

        @keyframes loading-pulse {

            0%,
            100% {
                transform: translateX(-100%);
                opacity: 0.7;
            }

            50% {
                transform: translateX(250%);
                opacity: 1;
            }
        }

        .global-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .global-progress-percent {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .global-progress-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Trade Row Click Styles */
        .trade-row {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .trade-row:hover {
            background: rgba(29, 155, 240, 0.15) !important;
        }

        .trade-row.selected {
            background: rgba(29, 155, 240, 0.25) !important;
            outline: 2px solid var(--accent);
            outline-offset: -2px;
        }

        /* Trade Explanation Panel */
        .trade-explanation-panel {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid var(--accent);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 0.8rem;
            line-height: 1.7;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .explanation-title {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.95rem;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .explanation-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #94a3b8;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .explanation-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .explanation-section {
            margin-bottom: 14px;
        }

        .explanation-section-title {
            font-weight: 600;
            color: #a78bfa;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .explanation-check {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 6px 0;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .explanation-check.pass {
            color: var(--success);
            border-left: 3px solid var(--success);
        }

        .explanation-check.fail {
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        .explanation-result {
            margin-top: 14px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        .explanation-result.win {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--success);
        }

        .explanation-result.loss {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .explanation-result.skip {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }
    </style>
</head>

<body>
    <header>
        <img src="/static/logo.png" alt="Stock Parameter Optimizer">
        <p>Bayesian optimization to find optimal buy/sell triggers for each stock</p>
    </header>

    <!-- Global Progress Bar -->
    <div class="global-progress" id="global-progress">
        <div class="global-progress-header">
            <span class="global-progress-title">‚è±Ô∏è Optimization in Progress</span>
            <button id="stop-optimization-btn" onclick="stopOptimization()"
                style="background: var(--danger); color: white; border: none; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; margin-left: 1rem;">‚èπ
                STOP</button>
            <div class="global-progress-stats">
                <div class="global-progress-stat">
                    <span class="global-progress-stat-label">Elapsed:</span>
                    <span class="global-progress-stat-value" id="elapsed-time">00:00</span>
                </div>
                <div class="global-progress-stat">
                    <span class="global-progress-stat-label">Remaining:</span>
                    <span class="global-progress-stat-value" id="remaining-time">--:--</span>
                </div>
                <div class="global-progress-stat">
                    <span class="global-progress-stat-label">Speed:</span>
                    <span class="global-progress-stat-value" id="trials-speed">-- trials/s</span>
                </div>
                <div class="global-progress-stat">
                    <span class="global-progress-stat-label">Iter:</span>
                    <span class="global-progress-stat-value" id="iter-count" style="color: var(--accent);">0/0</span>
                </div>
                <div class="global-progress-stat" style="min-width: 120px;">
                    <span class="global-progress-stat-label">Phase:</span>
                    <span class="global-progress-stat-value" id="phase-status"
                        style="color: #fbbf24;">Starting...</span>
                </div>
            </div>
        </div>
        <div class="global-progress-bar">
            <div class="global-progress-fill" id="global-progress-fill" style="width: 0%"></div>
            <span class="global-progress-percent" id="global-progress-percent">0%</span>
        </div>
        <div class="global-progress-footer">
            <span id="progress-stocks">Stock 0/0</span>
            <span id="progress-trials">Trial 0/0</span>
        </div>
    </div>

    <main>
        <aside class="panel">
            <h2>Configuration</h2>

            <div class="form-group">
                <label>Algorithm</label>
                <select id="algo-select" onchange="onAlgoChange()">
                    <option value="default">Dipper - Buy the Dip</option>
                    <option value="chatgpt">Momentum 10am</option>
                    <option value="chatgpt_stoploss">Momentum Stop Loss</option>
                    <option value="chatgpt_vwap">Momentum 10am + VWAP</option>
                    <option value="chatgpt_vwap_rust">Momentum 10am + VWAP (Rust ü¶Ä)</option>
                </select>
                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem;">
                    <span id="algo-description">Buy on dip, sell on profit target</span>
                </div>
            </div>

            <div class="form-group">
                <label>Stock Symbols (comma-separated) <span id="db-cache-indicator" class="db-cache-icon no-cache"
                        title="Data cached in DB">üíæ DB</span></label>
                <div class="symbol-input-wrapper">
                    <input type="text" id="symbols" value="TSLA" placeholder="TSLA, NVDA, AAPL"
                        oninput="checkSymbolCache()" />
                </div>
                <div id="cache-info"
                    style="display: none; margin-top: 6px; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; font-size: 0.7rem; color: var(--success); border-left: 3px solid #10b981;">
                </div>
                <button id="clear-cache-btn" type="button" onclick="clearPriceCache()"
                    style="margin-top: 6px; padding: 6px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 6px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 4px;"
                    title="Clear cached data to fetch fresh VWAP values">
                    üóëÔ∏è Clear Cache (Refresh VWAP)
                </button>
                <button id="clear-all-cache-btn" type="button" onclick="clearAllPriceCache()"
                    style="margin-top: 4px; padding: 6px 12px; background: rgba(239, 68, 68, 0.35); color: #ff6b6b; border: 1px solid rgba(239, 68, 68, 0.6); border-radius: 6px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 4px;"
                    title="Clear ALL cached price data for every symbol">
                    üóëÔ∏è Clear All Cache
                </button>
                <div id="clear-all-cache-progress" class="clear-all-cache-progress">
                    <div class="clear-all-cache-progress-row">
                        <span id="clear-all-cache-status">Preparing cache clear...</span>
                        <span id="clear-all-cache-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="clear-all-cache-fill" class="progress-bar-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div
                    style="margin-top: 8px; padding: 10px; background: rgba(29, 155, 240, 0.1); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px;">Quick Keywords:
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-primary); line-height: 1.6;">
                        <strong style="color: var(--success);">ALL</strong> ‚Üí SPY 500 (~500 stocks)<br>
                        <strong style="color: var(--warning);">CAP</strong> ‚Üí Large Cap Focus (~280 stocks)<br>
                        <strong style="color: var(--accent);">FULL</strong> ‚Üí Extended Sectors (~300 stocks)<br>
                        <strong style="color: #f472b6;">SPY500</strong> ‚Üí Stocks by Volume (API)<br>
                        <strong style="color: #00d752;">NASDAQ500</strong> ‚Üí Stocks by Volume (API)<br>
                        <strong style="color: #a78bfa;">1000</strong> ‚Üí Stocks by Volume (API)<br>
                        <strong style="color: #ff6b6b;">10000</strong> ‚Üí Top 10K by Transactions (API)
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="start-date" value="2024-01-01" />
            </div>

            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="end-date" value="2024-12-01" />
            </div>

            <div style="border-top: 1px solid var(--border); margin: 0.75rem 0; padding-top: 0.75rem;">
                <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.5rem;">üìä Backtest Date
                    Range (optional)</div>
                <div class="form-group" style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem;">Backtest Start</label>
                    <input type="date" id="backtest-start-date" value="" placeholder="Same as optimization" />
                </div>
                <div class="form-group">
                    <label style="font-size: 0.8rem;">Backtest End</label>
                    <input type="date" id="backtest-end-date" value="" placeholder="Same as optimization" />
                </div>
                <small style="color: var(--text-secondary); font-size: 0.65rem;">Leave blank to use same range as
                    optimization</small>
            </div>

            <div class="form-group">
                <label>Initial Capital ($)</label>
                <input type="number" id="capital" value="100000" />
            </div>

            <div class="form-group">
                <label>Optimization Trials</label>
                <input type="number" id="trials" value="200" min="50" max="1000" />
            </div>

            <div class="form-group">
                <label>Optimize For</label>
                <select id="metric">
                    <option value="sharpe">Sharpe Ratio</option>
                    <option value="total_return">Total Return</option>
                    <option value="win_rate">Win Rate</option>
                </select>
            </div>

            <div class="form-group">
                <label>üìä API Historic Data Source</label>
                <select id="data-source">
                    <option value="widesurf" selected>Widesurf API</option>
                    <option value="alpaca">Alpaca API</option>
                </select>
                <small style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.25rem; display: block;">
                    Select the data provider for historical price data
                </small>
            </div>

            <div class="form-group"
                style="display: flex; align-items: center; gap: 0.5rem; justify-content: space-between;">
                <label for="use-gpu" style="margin-bottom: 0; cursor: pointer;">Available GPU: RTX 3080 EVGA</label>
                <input type="checkbox" id="use-gpu" style="width: auto; margin-top: 0;" checked />
            </div>

            <div class="form-group"
                style="display: flex; align-items: center; gap: 0.5rem; justify-content: space-between;">
                <div style="display: flex; flex-direction: column;">
                    <label for="smart-timing" style="margin-bottom: 0; cursor: pointer;">‚è∞ Smart Entry Timing</label>
                    <small style="color: #888; font-size: 0.75em; margin-top: 0.2rem;">
                        Optimize buy time of day + triggers
                    </small>
                </div>
                <input type="checkbox" id="smart-timing" style="width: auto; margin-top: 0;" />
            </div>

            <div class="form-group" id="timing-approach-group"
                style="display: none; margin-left: 1rem; border-left: 2px solid #444; padding-left: 0.75rem;">
                <label for="timing-approach" style="margin-bottom: 0.5rem; font-size: 0.9em;">Timing Approach:</label>
                <select id="timing-approach" style="width: 100%; padding: 0.25rem;"
                    onchange="updateTimingDescription()">
                    <option value="sequential">Sequential (Faster) - Find timing after triggers</option>
                    <option value="joint">Joint (Better) - Optimize all parameters together</option>
                </select>
                <div id="timing-description"
                    style="margin-top: 0.5rem; padding: 8px 10px; background: rgba(29,155,240,0.08); border-left: 3px solid var(--accent); border-radius: 4px; font-size: 0.75rem; color: var(--text-secondary); line-height: 1.5;">
                </div>
                <div style="display: flex; align-items: center; gap: 0.4rem; margin-top: 0.25rem;">
                    <small style="color: #666; font-size: 0.7em;">
                        Sequential: ~30 sec faster | Joint: potentially better results
                    </small>
                    <span
                        onclick="document.getElementById('timing-info-panel').style.display = document.getElementById('timing-info-panel').style.display === 'none' ? 'block' : 'none'"
                        style="cursor: pointer; font-size: 0.85rem; opacity: 0.7; transition: opacity 0.2s;"
                        onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'"
                        title="Learn more about these approaches">‚ÑπÔ∏è</span>
                </div>

                <!-- Beginner-friendly explanation panel -->
                <div id="timing-info-panel"
                    style="display: none; margin-top: 0.75rem; background: linear-gradient(135deg, rgba(29,155,240,0.08), rgba(167,139,250,0.08)); border: 1px solid rgba(29,155,240,0.25); border-radius: 10px; padding: 1rem; font-size: 0.75rem; line-height: 1.6; animation: slideDown 0.2s ease;">

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-weight: 700; color: var(--accent); font-size: 0.85rem;">üìò How Smart Entry
                            Timing Works</span>
                        <span onclick="document.getElementById('timing-info-panel').style.display='none'"
                            style="cursor: pointer; color: #94a3b8; font-size: 0.9rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05);"
                            onmouseover="this.style.background='rgba(255,255,255,0.15)'"
                            onmouseout="this.style.background='rgba(255,255,255,0.05)'">&times;</span>
                    </div>

                    <div style="color: var(--text-secondary); margin-bottom: 0.75rem;">
                        Smart Entry Timing finds the <strong style="color: var(--text-primary);">best time of
                            day</strong> to buy a stock ‚Äî not just <em>what</em> triggers to use, but <em>when</em>
                        during the trading day to execute them.
                    </div>

                    <!-- Sequential explanation -->
                    <div
                        style="background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.6rem;">
                        <div style="font-weight: 700; color: #22c55e; margin-bottom: 0.4rem; font-size: 0.8rem;">‚ö°
                            Sequential (Faster)</div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Works in <strong style="color: var(--text-primary);">2 steps</strong> ‚Äî like choosing an
                            outfit, then picking shoes to match:
                        </div>
                        <div
                            style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.4rem;">
                            <span style="color: #22c55e;">Step 1:</span> Find the best buy/sell trigger %<br>
                            <span style="color: #22c55e;">Step 2:</span> Then find the best time of day for those
                            triggers
                        </div>
                        <div style="color: #888; font-size: 0.65rem;">
                            ‚úÖ ~30 seconds faster &nbsp; ‚ö†Ô∏è May miss combos where time + triggers work better together
                        </div>
                    </div>

                    <!-- Joint explanation -->
                    <div
                        style="background: rgba(167,139,250,0.08); border: 1px solid rgba(167,139,250,0.2); border-radius: 8px; padding: 0.75rem;">
                        <div style="font-weight: 700; color: #a78bfa; margin-bottom: 0.4rem; font-size: 0.8rem;">üß†
                            Joint (Better)</div>
                        <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                            Tests <strong style="color: var(--text-primary);">everything at once</strong> ‚Äî like trying
                            on full outfits head-to-toe to find the best combo:
                        </div>
                        <div
                            style="background: rgba(0,0,0,0.2); border-radius: 6px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.7rem; color: #94a3b8; margin-bottom: 0.4rem;">
                            <span style="color: #a78bfa;">All at once:</span> Buy trigger + Sell trigger + Time of
                            day<br>
                            <span style="color: #666;">‚Üí Explores all combinations simultaneously</span>
                        </div>
                        <div style="color: #888; font-size: 0.65rem;">
                            ‚úÖ Potentially finds the true best combo &nbsp; ‚ö†Ô∏è Takes ~30 seconds longer
                        </div>
                    </div>

                    <div
                        style="margin-top: 0.6rem; padding: 0.5rem 0.75rem; background: rgba(251,191,36,0.08); border-radius: 6px; border-left: 3px solid #fbbf24; color: #fbbf24; font-size: 0.65rem;">
                        üí° <strong>Tip:</strong> Start with <strong>Sequential</strong> for quick results. Use
                        <strong>Joint</strong> when you want the most thorough optimization and don't mind waiting a bit
                        longer.
                    </div>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.6rem;">
                <button class="btn btn-primary" id="start-btn" onclick="startOptimization(false)" style="width: 100%;">
                    Start Optimization
                </button>
                <button class="btn btn-secondary" id="partial-btn" onclick="startOptimization(true)"
                    style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    üß© Partial Optimization
                </button>
            </div>

            <div class="connection-status">
                <div class="connection-dot" id="ws-status"></div>
                <span id="ws-text">Connecting...</span>
            </div>
        </aside>

        <section>
            <!-- Top tabs for Results / API Tester / Keywords -->
            <div class="log-tabs" style="margin-bottom: 1rem;">
                <button class="log-tab active" id="tab-results" onclick="switchTopTab('results')">Results</button>
                <button class="log-tab" id="tab-api-tester" onclick="switchTopTab('api-tester')">API Tester</button>
                <button class="log-tab" id="tab-keywords" onclick="switchTopTab('keywords')">Keywords</button>
                <button class="log-tab" id="tab-api-keys" onclick="switchTopTab('api-keys')">API Keys</button>
                <button class="log-tab" id="tab-logs" onclick="switchTopTab('logs')">Logs</button>
            </div>

            <!-- API Tester Panel -->
            <div id="api-tester-panel"
                style="display: none; background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="color: var(--accent); margin-bottom: 1rem;">üî¨ API Price Comparison Tool</h3>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Compare price data
                    from Alpaca, Widesurf, and Massive.com APIs for a specific stock and date.</p>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label style="color: var(--text-secondary); font-size: 0.8rem;">Stock Ticker</label>
                        <input type="text" id="api-test-ticker" placeholder="TSLA"
                            onkeypress="if(event.key==='Enter') runApiTest()"
                            style="width: 100%; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);" />
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 0.8rem;">Date</label>
                        <input type="date" id="api-test-date"
                            style="width: 100%; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);" />
                    </div>
                    <div>
                        <label style="color: var(--text-secondary); font-size: 0.8rem;">Time (HH:MM)</label>
                        <input type="text" id="api-test-time" placeholder="10:00" value="10:00"
                            style="width: 100%; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text);" />
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                    <button onclick="runApiTest()"
                        style="background: var(--accent); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üöÄ Fetch & Compare
                    </button>
                    <div id="weekend-warning-inline" style="flex: 1;"></div>
                </div>

                <div id="api-test-results" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <!-- Alpaca Results -->
                        <div
                            style="background: rgba(0,200,100,0.1); border: 1px solid var(--success); border-radius: 8px; padding: 0.75rem;">
                            <h4 style="color: var(--success); margin-bottom: 0.5rem; font-size: 0.9rem;">üìà Alpaca</h4>
                            <div id="alpaca-results" style="font-size: 0.75rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                                    <span style="color: var(--text-secondary);">Open:</span>
                                    <span id="alpaca-open" style="font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">User Price:</span>
                                    <span id="alpaca-user-price" style="font-weight: bold; color: #22c55e;">--</span>

                                    <span style="color: var(--text-secondary);">Close:</span>
                                    <span id="alpaca-close" style="font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">Vol (Daily):</span>
                                    <span id="alpaca-volume-daily">--</span>

                                    <span style="color: var(--text-secondary);">Vol (to time):</span>
                                    <span id="alpaca-volume-time">--</span>

                                    <span style="color: #a78bfa; font-weight: bold;">VWAP:</span>
                                    <span id="alpaca-vwap-time" style="color: #a78bfa; font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">VWAP Daily:</span>
                                    <span id="alpaca-vwap-daily">--</span>

                                    <span style="color: var(--text-secondary);">Bars:</span>
                                    <span id="alpaca-bars-count">--</span>
                                </div>
                                <div
                                    style="margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.4rem; font-size: 0.65rem; color: var(--text-secondary); line-height: 1.2;">
                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                        title="API Endpoint">üìç <span id="alpaca-endpoint">--</span></div>
                                    <div style="font-family: monospace;">üîë <span id="alpaca-key">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Widesurf Results -->
                        <div
                            style="background: rgba(167,139,250,0.1); border: 1px solid #a78bfa; border-radius: 8px; padding: 0.75rem;">
                            <h4 style="color: #a78bfa; margin-bottom: 0.5rem; font-size: 0.9rem;">üî∑ Widesurf</h4>
                            <div id="widesurf-results" style="font-size: 0.75rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                                    <span style="color: var(--text-secondary);">Open:</span>
                                    <span id="widesurf-open" style="font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">User Price:</span>
                                    <span id="widesurf-user-price" style="font-weight: bold; color: #a78bfa;">--</span>

                                    <span style="color: var(--text-secondary);">Close:</span>
                                    <span id="widesurf-close" style="font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">Vol (Daily):</span>
                                    <span id="widesurf-volume-daily">--</span>

                                    <span style="color: var(--text-secondary);">Vol (to time):</span>
                                    <span id="widesurf-volume-time">--</span>

                                    <span style="color: #a78bfa; font-weight: bold;">VWAP:</span>
                                    <span id="widesurf-vwap-time" style="color: #a78bfa; font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">VWAP Daily:</span>
                                    <span id="widesurf-vwap-daily">--</span>

                                    <span style="color: var(--text-secondary);">Bars:</span>
                                    <span id="widesurf-bars-count">--</span>
                                </div>
                                <div
                                    style="margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.4rem; font-size: 0.65rem; color: var(--text-secondary); line-height: 1.2;">
                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                        title="API Endpoint">üìç <span id="widesurf-endpoint">--</span></div>
                                    <div style="font-family: monospace;">üîë <span id="widesurf-key">--</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Massive.com Results -->
                        <div
                            style="background: rgba(255,165,0,0.1); border: 1px solid #ffa500; border-radius: 8px; padding: 0.75rem;">
                            <h4 style="color: #ffa500; margin-bottom: 0.5rem; font-size: 0.9rem;">üü† Massive.com</h4>
                            <div id="massive-results" style="font-size: 0.75rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem;">
                                    <span style="color: var(--text-secondary);">Open:</span>
                                    <span id="massive-open" style="font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">User Price:</span>
                                    <span id="massive-user-price" style="font-weight: bold; color: #ffa500;">--</span>

                                    <span style="color: var(--text-secondary);">Close:</span>
                                    <span id="massive-close" style="font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">Vol (Daily):</span>
                                    <span id="massive-volume-daily">--</span>

                                    <span style="color: var(--text-secondary);">Vol (to time):</span>
                                    <span id="massive-volume-time">--</span>

                                    <span style="color: #ffa500; font-weight: bold;">VWAP:</span>
                                    <span id="massive-vwap-time" style="color: #ffa500; font-weight: bold;">--</span>

                                    <span style="color: var(--text-secondary);">VWAP Daily:</span>
                                    <span id="massive-vwap-daily">--</span>

                                    <span style="color: var(--text-secondary);">Bars:</span>
                                    <span id="massive-bars-count">--</span>
                                </div>
                                <div
                                    style="margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.4rem; font-size: 0.65rem; color: var(--text-secondary); line-height: 1.2;">
                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                        title="API Endpoint">üìç <span id="massive-endpoint">--</span></div>
                                    <div style="font-family: monospace;">üîë <span id="massive-key">--</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comparison Summary -->
                    <div id="api-comparison"
                        style="margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 8px;">
                        <h4 style="color: var(--accent); margin-bottom: 0.5rem;">üìä Comparison</h4>
                        <div id="comparison-details" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                    </div>
                </div>

                <div id="api-test-loading" style="display: none; text-align: center; padding: 2rem;">
                    <div style="color: var(--accent);">‚è≥ Fetching data from APIs...</div>
                </div>

                <div id="api-test-error"
                    style="display: none; padding: 1rem; background: rgba(239,68,68,0.1); border: 1px solid var(--danger); border-radius: 8px; color: var(--danger);">
                </div>
            </div>

            <!-- Keywords Configuration Panel -->
            <div id="keywords-panel"
                style="display: none; background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="color: var(--accent); margin-bottom: 1rem;">üîë Keyword API Configurations</h3>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                    Configure the API URLs for each stock list keyword. These are used when selecting quick keywords in
                    the Stock Symbols field.
                </p>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- ALL Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #22c55e; min-width: 100px;">ALL</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">SPY 500 stocks (~500)</span>
                        </div>
                        <input type="text" id="keyword-url-ALL" placeholder="API URL or STATIC:LIST_NAME"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>

                    <!-- CAP Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #3b82f6; min-width: 100px;">CAP</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">Large Cap Focus
                                (~280)</span>
                        </div>
                        <input type="text" id="keyword-url-CAP" placeholder="API URL or STATIC:LIST_NAME"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>

                    <!-- FULL Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #f59e0b; min-width: 100px;">FULL</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">Extended Sectors
                                (~300)</span>
                        </div>
                        <input type="text" id="keyword-url-FULL" placeholder="API URL or STATIC:LIST_NAME"
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>

                    <!-- SPY500 Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #ef4444; min-width: 100px;">SPY500</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">Widesurf API - Top 500 by
                                volume</span>
                        </div>
                        <input type="text" id="keyword-url-SPY500"
                            placeholder="https://api.widesurf.com/v1/reference/tickers?..."
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>

                    <!-- NASDAQ500 Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #8b5cf6; min-width: 100px;">NASDAQ500</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">Widesurf API - NASDAQ 500 by
                                volume</span>
                        </div>
                        <input type="text" id="keyword-url-NASDAQ500"
                            placeholder="https://api.widesurf.com/v1/reference/tickers?..."
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>

                    <!-- 1000 Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #a78bfa; min-width: 100px;">1000</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">Widesurf API - Top 1000 by
                                volume</span>
                        </div>
                        <input type="text" id="keyword-url-1000"
                            placeholder="https://api.widesurf.com/v1/reference/tickers?..."
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>

                    <!-- 10000 Keyword -->
                    <div
                        style="background: var(--bg-input); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <strong style="color: #ff6b6b; min-width: 100px;">10000</strong>
                            <span style="color: var(--text-secondary); font-size: 0.75rem;">Polygon API - Top 10,000 by
                                transactions</span>
                        </div>
                        <input type="text" id="keyword-url-10000"
                            placeholder="http://10.0.0.94:8020/v1/reference/tickers?..."
                            style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8rem;" />
                    </div>
                </div>

                <!-- Save Button -->
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button onclick="saveKeywordConfigs()"
                        style="flex: 1; padding: 0.75rem 1.5rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üíæ Save Keyword Configurations
                    </button>
                    <button onclick="loadKeywordConfigs()"
                        style="padding: 0.75rem 1rem; background: var(--bg-input); color: var(--text); border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                        üîÑ Reload
                    </button>
                </div>

                <div id="keywords-status" style="margin-top: 1rem; padding: 0.5rem; border-radius: 6px; display: none;">
                </div>
            </div>

            <!-- API Keys Configuration Panel -->
            <div id="api-keys-panel"
                style="display: none; background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                <h3 style="color: var(--accent); margin-bottom: 1rem;">üîê API Secret Keys</h3>
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                    Configure your API keys, secret keys, and base endpoints for various providers.
                </p>

                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Alpaca API -->
                    <div
                        style="background: var(--bg-card); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4
                            style="color: var(--accent); margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ü¶ô</span> Alpaca API
                        </h4>
                        <div
                            style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label>Key ID</label>
                                <input type="text" id="api-key-alpaca-id" class="form-input"
                                    placeholder="Alpaca Key ID">
                            </div>
                            <div class="form-group">
                                <label>Secret Key</label>
                                <input type="password" id="api-key-alpaca-secret" class="form-input"
                                    placeholder="Alpaca Secret Key">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Base Endpoint</label>
                            <input type="text" id="api-key-alpaca-url" class="form-input"
                                placeholder="https://paper-api.alpaca.markets/v2">
                        </div>
                    </div>

                    <div
                        style="background: var(--bg-card); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4
                            style="color: var(--accent); margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üåä</span> Massive API
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" id="api-key-massive-secret" class="form-input"
                                    placeholder="Massive API Key">
                            </div>
                            <div class="form-group">
                                <label>Base Endpoint</label>
                                <input type="text" id="api-key-massive-url" class="form-input"
                                    placeholder="https://api.massive.com">
                            </div>
                        </div>
                    </div>

                    <div
                        style="background: var(--bg-card); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--border);">
                        <h4
                            style="color: var(--accent); margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìà</span> Widesurf API
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" id="api-key-widesurf-secret" class="form-input"
                                    placeholder="Widesurf API Key">
                            </div>
                            <div class="form-group">
                                <label>Base Endpoint</label>
                                <input type="text" id="api-key-widesurf-url" class="form-input"
                                    placeholder="http://10.0.0.94:8020">
                            </div>
                        </div>
                    </div>

                </div>

                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="saveApiKeys()" style="flex: 2;">
                        üíæ Save API Keys
                    </button>
                    <button class="btn" onclick="loadApiKeys()"
                        style="flex: 1; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);">
                        üîÑ Reload
                    </button>
                </div>

                <div id="api-keys-status" style="margin-top: 1rem; padding: 0.5rem; border-radius: 6px; display: none;">
                </div>
            </div>

            <!-- Logs Panel -->
            <div id="logs-panel"
                style="display: none; background: var(--card-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; max-height: 75vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: var(--accent); margin: 0;">Run Logs</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn" onclick="loadJobLogs()"
                            style="background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                            Refresh
                        </button>
                        <button class="btn" onclick="clearJobLogs()"
                            style="background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Live session log -->
                <div style="margin-bottom: 1.25rem;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Live Session</div>
                    <div id="live-log-container"
                        style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.78rem; line-height: 1.5;">
                        <div style="color: var(--text-secondary);">Waiting for optimization run...</div>
                    </div>
                </div>

                <!-- Job history -->
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">Job History</div>
                    <!-- Column headers -->
                    <div style="display: grid; grid-template-columns: 110px 1fr 70px 55px 60px 55px 70px 40px; padding: 0.35rem 0.75rem; font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; gap: 0.25rem;">
                        <div>Date</div>
                        <div>Algo / Source</div>
                        <div style="text-align: center;">Stocks</div>
                        <div style="text-align: center;">Ret</div>
                        <div style="text-align: center;">Win%</div>
                        <div style="text-align: center;">Duration</div>
                        <div style="text-align: center;">Status</div>
                        <div></div>
                    </div>
                    <div id="job-history-list">
                        <div style="color: var(--text-secondary); font-size: 0.85rem; padding: 1rem; text-align: center;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="results-container" id="results">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    <h3>No Results Yet</h3>
                    <p>Configure settings and start optimization</p>
                </div>
            </div>

            <div class="log-tabs">
                <button class="log-tab active" id="tab-status" onclick="switchLogTab('status')">Status</button>
                <button class="log-tab" id="tab-analysis" onclick="switchLogTab('analysis')">Analysis</button>
            </div>

            <div class="log-container" id="log">
                <div class="log-entry info">[System] Ready to optimize</div>
            </div>

            <div class="analysis-container" id="analysis" style="display: none;">
                <div class="analysis-empty">
                    <p>Run an optimization to see detailed analysis</p>
                </div>
            </div>
        </section>

        <aside class="panel history-panel">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                üìú History <span id="history-count"
                    style="font-size: 0.8em; color: var(--accent); font-weight: normal;">(0)</span>
                <button class="delete-all-btn" onclick="deleteAllHistory()" title="Delete All History">üóëÔ∏è</button>
            </h2>
            <button class="refresh-btn" onclick="loadHistory()">üîÑ Refresh History</button>
            <input type="text" id="history-search" class="search-input" placeholder="üîç Search symbol..."
                oninput="filterHistory()">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-bottom: 0.75rem;">
                <button class="sort-btn active" id="sort-date" onclick="sortHistory('date')"
                    title="Sort by most recently optimized">üìÖ Date</button>
                <button class="sort-btn" id="sort-sharpe" onclick="sortHistory('sharpe')"
                    title="Sort by Sharpe Ratio ‚Äî risk-adjusted return (higher = better risk/reward)">üìà Sharpe</button>
                <button class="sort-btn" id="sort-max" onclick="sortHistory('max')"
                    title="Sort by Maximum Gain ‚Äî highest single-day % gain found in backtest">üöÄ Max</button>
                <button class="sort-btn" id="sort-win" onclick="sortHistory('win')"
                    title="Sort by Win Rate ‚Äî % of trades that were profitable">üéØ Win</button>
                <button class="sort-btn" id="sort-fin" onclick="sortHistory('fin')"
                    title="Sort by Final Portfolio Value ‚Äî ending capital after backtest">üí∞ Fin</button>
                <button class="sort-btn" id="sort-amnt" onclick="sortHistory('amnt')"
                    title="Sort by Trade Count ‚Äî number of winning trades executed">üìä Amnt</button>
                <button class="sort-btn" id="sort-win2" onclick="sortHistory('win2')"
                    title="Sort by Win Rate v2 ‚Äî calculated directly from trade log">üèÜ Win2</button>
            </div>
            <div class="filter-row">
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-gpu" checked onchange="filterHistory()">
                    <span class="gpu-icon gpu">GPU</span>
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-cpu" checked onchange="filterHistory()">
                    <span class="gpu-icon cpu">CPU</span>
                </label>
            </div>
            <div class="history-list" id="history-list">
                <div class="empty-state" style="padding: 1rem;">
                    <p>No history yet</p>
                </div>
            </div>
        </aside>
    </main>

    <script>
        let ws = null;
        const results = {};
        const CONFIG_KEY = 'optimizer_config';
        let historyData = []; // Store history data
        let totalHistoryCount = 0; // Total history items in DB
        let currentSort = 'date'; // Current sort field
        let searchFilter = ''; // Search filter text
        let showGpuRuns = true; // GPU filter
        let showCpuRuns = true; // CPU filter
        let historyDisplayLimit = 30; // Pagination: items per page

        // Algorithm descriptions
        const algoDescriptions = {
            'default': 'Buy on dip, sell on profit target',
            'chatgpt': 'Buy at 10AM if price >= open+X%, sell at +Y% (optimized)',
            'chatgpt_stoploss': 'Momentum with Take Profit, Stop Loss, Trailing Stop + Trend Filter',
            'chatgpt_vwap': 'Entry @ 10AM if price < VWAP (mean reversion) + TP/SL + Protect Winner',
            'chatgpt_vwap_rust': 'ü¶Ä Rust + Rayon parallel (32 threads) ‚Äî same VWAP strategy, blazing fast'
        };

        // Handle algo selection change
        function onAlgoChange() {
            const algo = document.getElementById('algo-select').value;
            document.getElementById('algo-description').textContent = algoDescriptions[algo] || '';
            saveConfig();
        }

        // Global progress tracking
        let globalProgress = {
            totalSymbols: 0,
            completedSymbols: 0,
            trialsPerSymbol: 0,
            currentSymbolTrials: 0,
            startTime: null,
            timerInterval: null
        };

        // Helper function to sanitize metric values
        function sanitizeValue(value, isPercentage = false, decimals = 2) {
            if (value == null || value === -999999 || isNaN(value) || !isFinite(value)) {
                return 'N/A';
            }
            if (isPercentage) {
                return value.toFixed(decimals) + '%';
            }
            return value.toFixed(decimals);
        }

        // Cache check debounce timer
        let cacheCheckTimer = null;
        let cachedSymbols = {};
        let clearAllCachePolling = false;

        // Check if symbol data is cached in database
        async function clearPriceCache() {
            const input = document.getElementById('symbols').value.trim().toUpperCase();
            const symbols = input.split(',').map(s => s.trim()).filter(s => s && !['ALL', 'CAP', 'FULL', 'SPY500', 'NASDAQ500', '1000', '10000'].includes(s));

            if (symbols.length === 0) {
                log('No symbols to clear cache for', 'warning');
                return;
            }

            const btn = document.getElementById('clear-cache-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Clearing...';

            try {
                let clearedCount = 0;
                for (const symbol of symbols) {
                    // Clear both 1Day and 1Min cache
                    const res1 = await fetch(`/api/price-cache/${symbol}?timeframe=1Min`, { method: 'DELETE' });
                    const res2 = await fetch(`/api/price-cache/${symbol}?timeframe=1Day`, { method: 'DELETE' });
                    if (res1.ok || res2.ok) clearedCount++;
                }

                log(`‚úÖ Cache cleared for ${clearedCount} symbol(s). Run optimization to fetch fresh VWAP data.`, 'success');

                // Refresh cache check
                checkSymbolCache();
            } catch (error) {
                log(`‚ùå Failed to clear cache: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üóëÔ∏è Clear Cache (Refresh VWAP)';
            }
        }

        function setClearAllCacheProgress(percent, statusText) {
            const wrapper = document.getElementById('clear-all-cache-progress');
            const fill = document.getElementById('clear-all-cache-fill');
            const pctLabel = document.getElementById('clear-all-cache-percent');
            const statusLabel = document.getElementById('clear-all-cache-status');

            if (!wrapper || !fill || !pctLabel || !statusLabel) return;

            const clamped = Math.max(0, Math.min(100, Number(percent || 0)));
            wrapper.classList.add('active');
            fill.style.width = `${clamped}%`;
            pctLabel.textContent = `${Math.round(clamped)}%`;
            if (statusText) {
                statusLabel.textContent = statusText;
            }
        }

        function hideClearAllCacheProgress() {
            const wrapper = document.getElementById('clear-all-cache-progress');
            if (!wrapper) return;
            wrapper.classList.remove('active');
        }

        async function readJsonSafe(response) {
            try {
                return await response.json();
            } catch (error) {
                return {};
            }
        }

        async function pollClearAllCacheJob(jobId, btn) {
            const pollDelayMs = 800;
            clearAllCachePolling = true;

            while (clearAllCachePolling) {
                const statusRes = await fetch(`/api/price-cache/clear-all/${jobId}`);
                const statusData = await readJsonSafe(statusRes);
                if (!statusRes.ok) {
                    throw new Error(statusData.detail || `Status request failed (${statusRes.status})`);
                }

                const percent = Number(statusData.percent || 0);
                const shownPercent = (statusData.status === 'running' && percent <= 0) ? 1 : percent;
                const deletedBars = Number(statusData.deleted_bars || 0);
                const deletedMeta = Number(statusData.deleted_meta || 0);
                const phase = (statusData.phase || 'running').replace(/_/g, ' ');
                const fallbackStatus = `${phase} ‚Ä¢ ${deletedBars.toLocaleString()} bars, ${deletedMeta.toLocaleString()} symbols`;
                const statusText = statusData.message || fallbackStatus;

                setClearAllCacheProgress(shownPercent, statusText);
                btn.innerHTML = `‚è≥ Clearing all... ${Math.round(shownPercent)}%`;

                if (statusData.status === 'completed') {
                    clearAllCachePolling = false;
                    setClearAllCacheProgress(100, statusData.message || 'Cache clear complete');
                    return statusData;
                }

                if (statusData.status === 'failed') {
                    clearAllCachePolling = false;
                    throw new Error(statusData.error || statusData.message || 'Cache clear failed');
                }

                await new Promise(resolve => setTimeout(resolve, pollDelayMs));
            }

            throw new Error('Cache clear polling interrupted');
        }

        async function clearAllPriceCache() {
            if (clearAllCachePolling) {
                log('‚ö†Ô∏è Cache clear already in progress', 'warning');
                return;
            }

            if (!confirm('Clear ALL cached price data for every symbol? This will force fresh downloads on next optimization.')) {
                return;
            }

            const btn = document.getElementById('clear-all-cache-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Clearing all...';
            setClearAllCacheProgress(1, 'Starting clear-all cache job...');

            try {
                const startRes = await fetch('/api/price-cache/clear-all', { method: 'POST' });
                const startData = await readJsonSafe(startRes);
                if (!startRes.ok) {
                    throw new Error(startData.detail || startData.message || 'Failed to start clear-all cache job');
                }

                const jobId = startData.job_id;
                if (!jobId) {
                    throw new Error('Missing job_id from cache clear API');
                }

                if (startData.status === 'running') {
                    log('‚ÑπÔ∏è Clear-all cache is already running. Re-attaching progress view...', 'warning');
                } else {
                    log('üßπ Started async clear-all cache job', 'info');
                }

                const finalStatus = await pollClearAllCacheJob(jobId, btn);
                log(`‚úÖ ${finalStatus.message || 'All cache cleared'}`, 'success');

                await loadCachedSymbolsList();
                checkSymbolCache();

                setTimeout(() => {
                    if (!clearAllCachePolling) {
                        hideClearAllCacheProgress();
                    }
                }, 2500);
            } catch (error) {
                clearAllCachePolling = false;
                setClearAllCacheProgress(0, `Failed: ${error.message}`);
                log(`‚ùå Failed to clear all cache: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üóëÔ∏è Clear All Cache';
            }
        }

        async function checkSymbolCache() {
            const input = document.getElementById('symbols').value.trim().toUpperCase();
            const indicator = document.getElementById('db-cache-indicator');
            const cacheInfo = document.getElementById('cache-info');

            // Skip keywords
            if (['ALL', 'CAP', 'FULL', 'SPY500', 'NASDAQ500', '1000', '10000'].includes(input)) {
                indicator.className = 'db-cache-icon no-cache';
                cacheInfo.style.display = 'none';
                return;
            }

            // Get first symbol only for single check
            const symbol = input.split(',')[0].trim();
            if (!symbol || symbol.length < 1) {
                indicator.className = 'db-cache-icon no-cache';
                cacheInfo.style.display = 'none';
                return;
            }

            // Debounce
            clearTimeout(cacheCheckTimer);
            cacheCheckTimer = setTimeout(async () => {
                try {
                    // Show loading state
                    indicator.className = 'db-cache-icon loading';
                    indicator.innerHTML = '‚è≥';
                    indicator.title = 'Checking cache...';

                    const response = await fetch(`/api/price-cache/check/${symbol}`);
                    const data = await response.json();

                    if (data.cached && data.data && data.data.length > 0) {
                        // Show cached indicator
                        indicator.className = 'db-cache-icon';
                        indicator.innerHTML = 'üíæ DB';

                        // Build cache info text
                        const dailyData = data.data.find(d => d.timeframe === '1Day' || d.timeframe === '1Day (legacy)');
                        if (dailyData) {
                            indicator.title = `${symbol} cached: ${dailyData.min_date} to ${dailyData.max_date} (${dailyData.bar_count} bars)`;
                            cacheInfo.innerHTML = `<strong>üíæ ${symbol}</strong> data cached: ${dailyData.min_date} ‚Üí ${dailyData.max_date} <span style="color: var(--text-secondary);">(${dailyData.bar_count} days)</span>`;
                            cacheInfo.style.display = 'block';
                        } else {
                            indicator.title = `${symbol} has cached data`;
                            cacheInfo.style.display = 'none';
                        }

                        // Store for later use
                        cachedSymbols[symbol] = data.data;
                    } else {
                        // No cache
                        indicator.className = 'db-cache-icon no-cache';
                        cacheInfo.style.display = 'none';
                        delete cachedSymbols[symbol];
                    }
                } catch (e) {
                    console.error('Cache check failed:', e);
                    indicator.className = 'db-cache-icon no-cache';
                    cacheInfo.style.display = 'none';
                }
            }, 300);
        }

        // Check cache on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkSymbolCache, 500);

            // Set backtest dates: Start = End Date + 1 day, End = Today
            const endDateVal = document.getElementById('end-date').value;
            if (endDateVal) {
                const endDate = new Date(endDateVal);
                endDate.setDate(endDate.getDate() + 1);
                const btStart = endDate.toISOString().split('T')[0];
                document.getElementById('backtest-start-date').value = btStart;
            }
            // Get today in Chicago/CDT timezone
            const chicagoDate = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
            document.getElementById('backtest-end-date').value = chicagoDate;

            // Set API Tester date to today (Chicago time)
            document.getElementById('api-test-date').value = chicagoDate;
        });

        // Switch between Results, API Tester, and Keywords tabs
        function switchTopTab(tab) {
            const tabs = {
                'results': document.getElementById('tab-results'),
                'api-tester': document.getElementById('tab-api-tester'),
                'keywords': document.getElementById('tab-keywords'),
                'api-keys': document.getElementById('tab-api-keys'),
                'logs': document.getElementById('tab-logs'),
            };
            const panels = {
                'results': document.getElementById('results'),
                'api-tester': document.getElementById('api-tester-panel'),
                'keywords': document.getElementById('keywords-panel'),
                'api-keys': document.getElementById('api-keys-panel'),
                'logs': document.getElementById('logs-panel'),
            };

            // Reset all
            Object.values(tabs).forEach(t => t && t.classList.remove('active'));
            Object.values(panels).forEach(p => p && (p.style.display = 'none'));

            // Activate selected
            if (tabs[tab]) tabs[tab].classList.add('active');
            if (panels[tab]) panels[tab].style.display = (tab === 'results') ? 'flex' : 'block';

            // Side effects
            if (tab === 'keywords') loadKeywordConfigs();
            if (tab === 'api-keys') loadApiKeys();
            if (tab === 'logs') loadJobLogs();
        }

        // ‚îÄ‚îÄ Logs Tab Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadJobLogs() {
            const container = document.getElementById('job-history-list');
            try {
                const resp = await fetch('/api/jobs?limit=100');
                const jobs = await resp.json();
                if (!jobs.length) {
                    container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem; padding: 1rem; text-align: center;">No optimization runs yet.</div>';
                    return;
                }
                container.innerHTML = jobs.map(j => renderJobRow(j)).join('');
            } catch (e) {
                container.innerHTML = `<div style="color: #ef4444; padding: 1rem;">Failed to load jobs: ${e.message}</div>`;
            }
        }

        async function clearJobLogs() {
            if (!confirm('Delete all job logs? This also removes associated optimization results.')) return;
            try {
                const resp = await fetch('/api/jobs', { method: 'DELETE' });
                const data = await resp.json();
                // Clear caches
                Object.keys(_jobDetailCache).forEach(k => delete _jobDetailCache[k]);
                // Clear live log
                const liveLog = document.getElementById('live-log-container');
                if (liveLog) { liveLog.innerHTML = '<div style="color: var(--text-secondary);">Waiting for optimization run...</div>'; delete liveLog.dataset.started; }
                // Reload
                loadJobLogs();
                loadHistory();
            } catch (e) {
                alert('Failed to clear logs: ' + e.message);
            }
        }

        function renderJobRow(job) {
            const date = job.created_at ? new Date(job.created_at) : null;
            const dateStr = date ? date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî';
            const timeStr = date ? date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
            const stockCount = job.symbols ? job.symbols.length : 0;
            const resultCount = job.result_count || 0;
            const avgRet = job.avg_return != null ? job.avg_return.toFixed(1) + '%' : '‚Äî';
            const avgWin = job.avg_win_rate != null ? job.avg_win_rate.toFixed(0) + '%' : '‚Äî';
            const dur = job.duration_seconds != null ? formatDuration(job.duration_seconds) : '‚Äî';
            const algo = formatAlgoName(job.algo || 'default');
            const source = formatSourceName(job.data_source || 'widesurf');
            const isCompleted = job.status === 'completed';
            const statusBadge = isCompleted
                ? '<span style="color: #22c55e; font-size: 0.75rem;">DONE</span>'
                : '<span style="color: #f59e0b; font-size: 0.75rem;">RUN</span>';

            return `
            <div style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; overflow: hidden;">
                <div onclick="toggleJobDetail('${job.job_id}')" style="display: grid; grid-template-columns: 110px 1fr 70px 55px 60px 55px 70px 40px; align-items: center; padding: 0.6rem 0.75rem; cursor: pointer; font-size: 0.8rem; gap: 0.25rem;"
                     onmouseenter="this.style.background='var(--bg-card)'" onmouseleave="this.style.background='transparent'">
                    <div>
                        <div style="color: var(--text-primary); font-weight: 500;">${dateStr}</div>
                        <div style="color: var(--text-secondary); font-size: 0.72rem;">${timeStr}</div>
                    </div>
                    <div>
                        <div style="color: var(--accent); font-weight: 500;">${algo}</div>
                        <div style="color: var(--text-secondary); font-size: 0.72rem;">${source}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--text-primary);">${resultCount}/${stockCount}</div>
                        <div style="color: var(--text-secondary); font-size: 0.7rem;">stocks</div>
                    </div>
                    <div style="text-align: center; color: ${parseFloat(avgRet) > 0 ? '#22c55e' : parseFloat(avgRet) < 0 ? '#ef4444' : 'var(--text-secondary)'}; font-weight: 600;">
                        ${avgRet}
                    </div>
                    <div style="text-align: center; color: var(--text-secondary);">${avgWin}</div>
                    <div style="text-align: center; color: var(--text-secondary); font-size: 0.78rem;">${dur}</div>
                    <div style="text-align: center;">${statusBadge}</div>
                    <div style="text-align: center; color: var(--text-secondary); font-size: 0.7rem;" id="arrow-${job.job_id}">&#9654;</div>
                </div>
                <div id="detail-${job.job_id}" style="display: none; border-top: 1px solid var(--border); padding: 0.75rem; background: var(--bg-card);">
                    <div style="color: var(--text-secondary); font-size: 0.78rem;">Loading...</div>
                </div>
            </div>`;
        }

        function formatDuration(secs) {
            if (secs < 60) return Math.round(secs) + 's';
            if (secs < 3600) return Math.round(secs / 60) + 'm';
            return (secs / 3600).toFixed(1) + 'h';
        }

        function formatAlgoName(algo) {
            const names = {
                'default': 'Momentum',
                'momentum': 'Momentum',
                'chatgpt': 'ChatGPT 10am',
                'chatgpt_stoploss': 'ChatGPT SL',
                'chatgpt_vwap': 'VWAP',
                'chatgpt_vwap_rust': 'VWAP Rust',
            };
            return names[algo] || algo;
        }

        function formatSourceName(src) {
            const names = {
                'widesurf': 'Widesurf',
                'alpaca': 'Alpaca',
            };
            return names[src] || src;
        }

        const _jobDetailCache = {};
        async function toggleJobDetail(jobId) {
            const el = document.getElementById('detail-' + jobId);
            const arrow = document.getElementById('arrow-' + jobId);
            if (!el) return;
            if (el.style.display !== 'none') {
                el.style.display = 'none';
                if (arrow) arrow.innerHTML = '&#9654;';
                return;
            }
            el.style.display = 'block';
            if (arrow) arrow.innerHTML = '&#9660;';

            if (_jobDetailCache[jobId]) {
                el.innerHTML = renderJobDetails(_jobDetailCache[jobId]);
                return;
            }
            try {
                const resp = await fetch('/api/jobs/' + jobId);
                const data = await resp.json();
                _jobDetailCache[jobId] = data;
                el.innerHTML = renderJobDetails(data);
            } catch (e) {
                el.innerHTML = `<div style="color: #ef4444; font-size: 0.8rem;">Failed to load: ${e.message}</div>`;
            }
        }

        function renderJobDetails(results) {
            if (!results.length) return '<div style="color: var(--text-secondary); font-size: 0.8rem;">No results for this job.</div>';
            let html = '<div style="display: grid; grid-template-columns: 70px 60px 55px 55px 55px 50px; gap: 0.25rem; font-size: 0.72rem; color: var(--text-secondary); font-weight: 600; padding: 0 0.25rem 0.35rem; text-transform: uppercase; letter-spacing: 0.3px;">'
                + '<div>Symbol</div><div style="text-align:right">Return</div><div style="text-align:right">Win%</div><div style="text-align:right">Sharpe</div><div style="text-align:right">Buy%</div><div style="text-align:right">Sell%</div></div>';
            results.forEach(r => {
                const ret = r.total_return != null ? r.total_return.toFixed(1) + '%' : '‚Äî';
                const retColor = r.total_return > 0 ? '#22c55e' : r.total_return < 0 ? '#ef4444' : 'var(--text-secondary)';
                const win = r.win_rate != null ? r.win_rate.toFixed(0) + '%' : '‚Äî';
                const sharpe = r.sharpe != null ? r.sharpe.toFixed(2) : '‚Äî';
                const buy = r.buy_trigger_pct != null ? r.buy_trigger_pct.toFixed(1) : '‚Äî';
                const sell = r.sell_trigger_pct != null ? r.sell_trigger_pct.toFixed(1) : '‚Äî';
                html += `<div style="display: grid; grid-template-columns: 70px 60px 55px 55px 55px 50px; gap: 0.25rem; font-size: 0.78rem; padding: 0.2rem 0.25rem; border-bottom: 1px solid var(--border);">
                    <div style="color: var(--accent); font-weight: 500;">${r.symbol}</div>
                    <div style="text-align:right; color: ${retColor}; font-weight: 600;">${ret}</div>
                    <div style="text-align:right; color: var(--text-secondary);">${win}</div>
                    <div style="text-align:right; color: var(--text-secondary);">${sharpe}</div>
                    <div style="text-align:right; color: var(--text-secondary);">${buy}</div>
                    <div style="text-align:right; color: var(--text-secondary);">${sell}</div>
                </div>`;
            });
            return html;
        }

        // Append live WebSocket messages to the Logs tab live session area
        function appendToLiveLog(message, type) {
            const container = document.getElementById('live-log-container');
            if (!container) return;
            // Clear placeholder on first real message
            if (!container.dataset.started) {
                container.innerHTML = '';
                container.dataset.started = '1';
            }
            const entry = document.createElement('div');
            const colors = { info: '#60a5fa', success: '#22c55e', error: '#ef4444', warning: '#f59e0b' };
            entry.style.color = colors[type] || 'var(--text-secondary)';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            // Cap at 500 lines
            while (container.children.length > 500) container.removeChild(container.firstChild);
        }

        // Load keyword configurations from API
        async function loadKeywordConfigs() {
            try {
                const response = await fetch('/api/keywords');
                const data = await response.json();

                if (data.success && data.keywords) {
                    const keywords = ['ALL', 'CAP', 'FULL', 'SPY500', 'NASDAQ500', '1000', '10000'];
                    keywords.forEach(keyword => {
                        const input = document.getElementById(`keyword-url-${keyword}`);
                        if (input && data.keywords[keyword]) {
                            input.value = data.keywords[keyword].api_url || '';
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load keyword configs:', error);
            }
        }

        // Save keyword configurations to API
        async function saveKeywordConfigs() {
            const statusDiv = document.getElementById('keywords-status');
            const keywords = ['ALL', 'CAP', 'FULL', 'SPY500', 'NASDAQ500', '1000', '10000'];
            const configs = {};

            keywords.forEach(keyword => {
                const input = document.getElementById(`keyword-url-${keyword}`);
                if (input) {
                    configs[keyword] = {
                        api_url: input.value.trim(),
                        description: ''
                    };
                }
            });

            try {
                const response = await fetch('/api/keywords', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords: configs })
                });
                const data = await response.json();

                if (data.success) {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                    statusDiv.style.border = '1px solid #22c55e';
                    statusDiv.style.color = '#22c55e';
                    statusDiv.textContent = '‚úÖ Keyword configurations saved successfully!';
                    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
                } else {
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                    statusDiv.style.border = '1px solid #ef4444';
                    statusDiv.style.color = '#ef4444';
                    statusDiv.textContent = '‚ùå Failed to save: ' + (data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Failed to save keyword configs:', error);
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                statusDiv.style.border = '1px solid #ef4444';
                statusDiv.style.color = '#ef4444';
                statusDiv.textContent = '‚ùå Error: ' + error.message;
            }
        }

        // Clear all API test result fields
        function clearResultFields() {
            const sources = ['alpaca', 'widesurf', 'massive'];
            const fields = ['open', 'user-price', 'close', 'volume-daily', 'volume-time', 'vwap-time', 'vwap-daily', 'bars-count', 'endpoint', 'key'];
            sources.forEach(source => {
                fields.forEach(field => {
                    const el = document.getElementById(`${source}-${field}`);
                    if (el) el.textContent = '--';
                });
            });
            document.getElementById('weekend-warning-inline').innerHTML = '';
            document.getElementById('comparison-details').innerHTML = '';
        }

        // Run API comparison test
        async function runApiTest() {
            const ticker = document.getElementById('api-test-ticker').value.toUpperCase();
            const date = document.getElementById('api-test-date').value;
            const time = document.getElementById('api-test-time').value;

            if (!ticker || !date) {
                document.getElementById('api-test-error').style.display = 'block';
                document.getElementById('api-test-error').textContent = 'Please enter a stock ticker and date.';
                return;
            }

            // Show loading and clear previous results
            document.getElementById('api-test-loading').style.display = 'block';
            document.getElementById('api-test-results').style.display = 'none';
            document.getElementById('api-test-error').style.display = 'none';
            clearResultFields();

            try {
                // Call backend API to fetch from both sources
                const response = await fetch(`/api/price-compare?symbol=${ticker}&date=${date}&time=${time}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Populate API Source Metadata (Endpoints and Masked Keys)
                if (data.api_sources) {
                    ['alpaca', 'widesurf', 'massive'].forEach(source => {
                        if (data.api_sources[source]) {
                            document.getElementById(`${source}-endpoint`).textContent = data.api_sources[source].endpoint || 'N/A';
                            document.getElementById(`${source}-key`).textContent = data.api_sources[source].key_masked || 'N/A';
                        }
                    });
                }

                // Populate Alpaca results
                if (data.alpaca) {
                    document.getElementById('alpaca-open').textContent = data.alpaca.open_price ? `$${data.alpaca.open_price.toFixed(2)}` : 'N/A';
                    document.getElementById('alpaca-user-price').textContent = data.alpaca.user_price ? `$${data.alpaca.user_price.toFixed(2)} @ ${data.alpaca.user_time}` : 'N/A';
                    document.getElementById('alpaca-close').textContent = data.alpaca.close_price ? `$${data.alpaca.close_price.toFixed(2)}` : 'N/A';
                    document.getElementById('alpaca-volume-daily').textContent = data.alpaca.volume_daily ? data.alpaca.volume_daily.toLocaleString() : 'N/A';
                    document.getElementById('alpaca-volume-time').textContent = data.alpaca.volume_to_time ? data.alpaca.volume_to_time.toLocaleString() : 'N/A';
                    document.getElementById('alpaca-vwap-time').textContent = data.alpaca.vwap_to_time ? `$${data.alpaca.vwap_to_time.toFixed(4)}` : 'N/A';
                    document.getElementById('alpaca-vwap-daily').textContent = data.alpaca.vwap_daily ? `$${data.alpaca.vwap_daily.toFixed(4)}` : 'N/A';
                    document.getElementById('alpaca-bars-count').textContent = data.alpaca.bars_used_for_vwap || 'N/A';
                }

                // Populate Widesurf results
                if (data.widesurf) {
                    document.getElementById('widesurf-open').textContent = data.widesurf.open_price ? `$${data.widesurf.open_price.toFixed(2)}` : 'N/A';
                    document.getElementById('widesurf-user-price').textContent = data.widesurf.user_price ? `$${data.widesurf.user_price.toFixed(2)} @ ${data.widesurf.user_time}` : 'N/A';
                    document.getElementById('widesurf-close').textContent = data.widesurf.close_price ? `$${data.widesurf.close_price.toFixed(2)}` : 'N/A';
                    document.getElementById('widesurf-volume-daily').textContent = data.widesurf.volume_daily ? data.widesurf.volume_daily.toLocaleString() : 'N/A';
                    document.getElementById('widesurf-volume-time').textContent = data.widesurf.volume_to_time ? data.widesurf.volume_to_time.toLocaleString() : 'N/A';
                    document.getElementById('widesurf-vwap-time').textContent = data.widesurf.vwap_to_time ? `$${data.widesurf.vwap_to_time.toFixed(4)}` : 'N/A';
                    document.getElementById('widesurf-vwap-daily').textContent = data.widesurf.vwap_daily ? `$${data.widesurf.vwap_daily.toFixed(4)}` : 'N/A';
                    document.getElementById('widesurf-bars-count').textContent = data.widesurf.bars_used_for_vwap || 'N/A';
                }

                // Populate Massive.com results
                if (data.massive) {
                    document.getElementById('massive-open').textContent = data.massive.open_price ? `$${data.massive.open_price.toFixed(2)}` : 'N/A';
                    document.getElementById('massive-user-price').textContent = data.massive.user_price ? `$${data.massive.user_price.toFixed(2)} @ ${data.massive.user_time}` : 'N/A';
                    document.getElementById('massive-close').textContent = data.massive.close_price ? `$${data.massive.close_price.toFixed(2)}` : 'N/A';
                    document.getElementById('massive-volume-daily').textContent = data.massive.volume_daily ? data.massive.volume_daily.toLocaleString() : 'N/A';
                    document.getElementById('massive-volume-time').textContent = data.massive.volume_to_time ? data.massive.volume_to_time.toLocaleString() : 'N/A';
                    document.getElementById('massive-vwap-time').textContent = data.massive.vwap_to_time ? `$${data.massive.vwap_to_time.toFixed(4)}` : 'N/A';
                    document.getElementById('massive-vwap-daily').textContent = data.massive.vwap_daily ? `$${data.massive.vwap_daily.toFixed(4)}` : 'N/A';
                    document.getElementById('massive-bars-count').textContent = data.massive.bars_used_for_vwap || 'N/A';
                }

                // Add weekend/holiday warning (inline only)
                if (data.market_status === 'closed') {
                    let warningText = data.warning.split('.')[0];
                    if (!warningText.includes('Market closed') && !warningText.includes('Market Closed')) {
                        warningText += ' - Market closed';
                    }
                    const warningHtml = `<div style="background: rgba(244, 33, 46, 0.2); border: 1px solid var(--danger); border-radius: 6px; padding: 0.5rem 0.75rem; font-size: 0.75rem; color: var(--danger); display: inline-flex; align-items: center; gap: 0.5rem;">
                        ‚ö†Ô∏è <strong>${warningText}</strong>
                    </div>`;
                    document.getElementById('weekend-warning-inline').innerHTML = warningHtml;

                    // Force clear fields again if market is closed to be double-sure
                    if (!data.alpaca && !data.widesurf && !data.massive) {
                        // We already called clearResultFields() at the start, but if the backend didn't return data, we stay clear.
                    }
                } else {
                    document.getElementById('weekend-warning-inline').innerHTML = '';
                }

                let comparisonHtml = '';
                if (data.market_status !== 'closed' && data.alpaca && data.alpaca.user_price) {
                    comparisonHtml = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <span>User Time:</span><span style="color: var(--success); font-weight: bold;">${time}</span>
                            <span>Price Change (Open‚ÜíTime):</span><span style="color: ${data.alpaca && data.alpaca.user_price > data.alpaca.open_price ? 'var(--success)' : 'var(--danger)'};">${data.alpaca && data.alpaca.open_price ? ((data.alpaca.user_price - data.alpaca.open_price) / data.alpaca.open_price * 100).toFixed(2) + '%' : 'N/A'}</span>
                        </div>
                    `;
                }
                document.getElementById('comparison-details').innerHTML = comparisonHtml;

                // Show results
                document.getElementById('api-test-loading').style.display = 'none';
                document.getElementById('api-test-results').style.display = 'block';

            } catch (error) {
                document.getElementById('api-test-loading').style.display = 'none';
                document.getElementById('api-test-error').style.display = 'block';
                document.getElementById('api-test-error').textContent = `Error: ${error.message}`;
            }
        }

        // Switch between Status and Analysis tabs
        function switchLogTab(tab) {
            const statusTab = document.getElementById('tab-status');
            const analysisTab = document.getElementById('tab-analysis');
            const logContainer = document.getElementById('log');
            const analysisContainer = document.getElementById('analysis');

            if (tab === 'status') {
                statusTab.classList.add('active');
                analysisTab.classList.remove('active');
                logContainer.style.display = 'block';
                analysisContainer.style.display = 'none';
            } else {
                statusTab.classList.remove('active');
                analysisTab.classList.add('active');
                logContainer.style.display = 'none';
                analysisContainer.style.display = 'block';
            }
        }

        // Trade log state for sorting
        let currentTradeLog = [];
        let currentTradeLogMeta = {};
        let tradeLogSortColumn = 'day';
        let tradeLogSortAsc = true;

        // Update Analysis tab with detailed algorithm results
        function updateAnalysisView(result) {
            const container = document.getElementById('analysis');
            if (!result || !result.symbol) {
                container.innerHTML = '<div class="analysis-empty"><p>Run an optimization to see detailed analysis</p></div>';
                return;
            }

            const v = result.volatility_profile || {};
            const m = result.metrics || {};
            const p = result.best_params || {};

            // Ensure trade_log is an array
            let tradeLog = result.trade_log || [];
            if (!Array.isArray(tradeLog)) {
                console.warn('tradeLog is not an array, converting:', typeof tradeLog);
                try {
                    if (typeof tradeLog === 'string') {
                        tradeLog = JSON.parse(tradeLog);
                    } else {
                        tradeLog = [];
                    }
                } catch (e) {
                    console.error('Failed to parse trade_log:', e);
                    tradeLog = [];
                }
            }

            console.log('updateAnalysisView - tradeLog length:', tradeLog.length, 'algo:', result.algo);

            // Store for sorting
            currentTradeLog = tradeLog.map((t, i) => ({ ...t, day: i + 1 }));
            currentTradeLogMeta = {
                symbol: result.symbol,
                params: p,
                metrics: m,
                start_date: result.start_date,
                end_date: result.end_date,
                algo: result.algo || 'default',
                data_source: result.data_source || 'alpaca'
            };
            tradeLogSortColumn = 'day';
            tradeLogSortAsc = true;

            console.log('Rendering analysis view with tradeLog length:', currentTradeLog.length);
            renderAnalysisView();
        }

        // Store current trade metadata for the explanation panel
        let currentTradeParams = {};
        let currentAlgoFlags = { isVWAP: false, isChatGPT: false, isStopLoss: false };

        // Show trade explanation panel when clicking on a row
        function showTradeExplanation(tradeIndex) {
            const t = currentTradeLog[tradeIndex];
            if (!t) return;

            const p = currentTradeParams;
            const { isVWAP, isChatGPT, isStopLoss } = currentAlgoFlags;

            // Remove previous selection
            document.querySelectorAll('.trade-row.selected').forEach(row => row.classList.remove('selected'));

            // Highlight selected row
            const selectedRow = document.querySelector(`[data-trade-index="${tradeIndex}"]`);
            if (selectedRow) selectedRow.classList.add('selected');

            const date = t.date ? t.date.substring(0, 10) : 'Unknown';
            const open = t.open?.toFixed(2) || 'N/A';
            const price10am = t.price_10am?.toFixed(2) || 'N/A';
            const vwap = t.vwap?.toFixed(2) || 'N/A';
            const close = t.close?.toFixed(2) || 'N/A';
            const sellTrigger = p.sell_trigger_pct || 'N/A';

            const pctFrom10amToOpen = t.open > 0 && t.price_10am ? (((t.price_10am - t.open) / t.open) * 100).toFixed(2) : '0';

            let html = `<div class="trade-explanation-panel">`;
            html += `<div class="explanation-title">
                <span>üìÖ ${date} ‚Äî ${t.bought ? '‚úÖ Trade Executed' : '‚ùå Trade Skipped'}</span>
                <button class="explanation-close" onclick="closeTradeExplanation()">‚úï</button>
            </div>`;

            if (isVWAP) {
                // VWAP Strategy Explanation
                html += `<div class="explanation-section">`;
                html += `<div class="explanation-section-title">üìä Market Snapshot at 10:00 AM</div>`;
                html += `<div style="color: #e2e8f0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">`;
                html += `‚Ä¢ The stock <b>opened</b> the day at <b>$${open}</b><br>`;
                html += `‚Ä¢ By <b>10:00 AM</b>, the price moved to <b>$${price10am}</b> ‚Äî that's <b>${pctFrom10amToOpen >= 0 ? '+' : ''}${pctFrom10amToOpen}%</b> from open<br>`;
                html += `‚Ä¢ The <b>VWAP</b> (Volume Weighted Average Price = the "fair" price where most volume traded) was <b>$${vwap}</b>`;
                html += `</div></div>`;

                html += `<div class="explanation-section">`;
                html += `<div class="explanation-section-title">üéØ Entry Conditions Checked (ALL must pass)</div>`;

                const priceAboveVwap = t.price_10am > t.vwap && t.vwap > 0;
                const skipReason = t.skip_reason || '';

                const c1Pass = priceAboveVwap;
                html += `<div class="explanation-check ${c1Pass ? 'pass' : 'fail'}">`;
                html += `<span style="font-size: 1.1rem;">${c1Pass ? '‚úì' : '‚úó'}</span>`;
                html += `<div><b>Price > VWAP:</b> Is $${price10am} above $${vwap}?<br>`;
                html += c1Pass ? `<i>YES! The stock is trading above its average price ‚Äî signs of strength.</i>` : `<i>NO. The stock is trading below average ‚Äî too weak to buy.</i>`;
                html += `</div></div>`;

                const c2Pass = !skipReason.includes('slope');
                html += `<div class="explanation-check ${c2Pass ? 'pass' : 'fail'}">`;
                html += `<span style="font-size: 1.1rem;">${c2Pass ? '‚úì' : '‚úó'}</span>`;
                html += `<div><b>VWAP Trending Up (Slope > 0):</b><br>`;
                html += c2Pass ? `<i>YES! VWAP is rising between 9:40-10AM ‚Äî buyers are in control.</i>` : `<i>NO. VWAP is falling ‚Äî sellers are dominating, skip this trade.</i>`;
                html += `</div></div>`;

                const c3Pass = !skipReason.includes('stretch');
                html += `<div class="explanation-check ${c3Pass ? 'pass' : 'fail'}">`;
                html += `<span style="font-size: 1.1rem;">${c3Pass ? '‚úì' : '‚úó'}</span>`;
                html += `<div><b>Price Not Overextended (Stretch < 0.5√óVolatility):</b><br>`;
                html += c3Pass ? `<i>YES! Price is close enough to VWAP ‚Äî safe entry point.</i>` : `<i>NO. Price has run up too far above VWAP ‚Äî chasing would be risky.</i>`;
                html += `</div></div>`;

                const c4Pass = !skipReason.includes('mom');
                html += `<div class="explanation-check ${c4Pass ? 'pass' : 'fail'}">`;
                html += `<span style="font-size: 1.1rem;">${c4Pass ? '‚úì' : '‚úó'}</span>`;
                html += `<div><b>Enough Momentum (Mom > 0.25√óVolatility):</b><br>`;
                html += c4Pass ? `<i>YES! Stock has solid upward momentum from open ‚Äî good entry.</i>` : `<i>NO. Not enough buying pressure yet ‚Äî wait for more momentum.</i>`;
                html += `</div></div>`;
                html += `</div>`;

                // Result section
                if (t.bought) {
                    const tpPrice = t.sell_price?.toFixed(2) || 'N/A';
                    const slPrice = t.stop_loss?.toFixed(2) || open;
                    const profitPct = t.buy_price > 0 ? (((t.actual_sell || t.close) - t.buy_price) / t.buy_price * 100).toFixed(2) : '0';

                    html += `<div class="explanation-result ${t.profit >= 0 ? 'win' : 'loss'}">`;
                    html += `<b>‚úÖ ALL 4 CONDITIONS PASSED ‚Üí BOUGHT at $${price10am}</b><br><br>`;
                    html += `<b>Exit Plan:</b><br>`;
                    html += `‚Ä¢ Take Profit (TP): Sell at $${tpPrice} (+${sellTrigger}% profit)<br>`;
                    html += `‚Ä¢ Stop Loss (SL): Sell at $${slPrice} (day's open price ‚Äî protection)<br><br>`;

                    if (t.exit_reason === 'TP') {
                        html += `<b>üéâ OUTCOME: WON!</b> Price hit our take profit target at $${tpPrice}.<br>`;
                    } else {
                        html += `<b>üìä OUTCOME:</b> Closed position at $${t.actual_sell?.toFixed(2) || close} at end of day.<br>`;
                    }
                    html += `<b>Profit: ${t.profit >= 0 ? '+' : ''}$${t.profit?.toFixed(0) || 0}</b> (${profitPct >= 0 ? '+' : ''}${profitPct}% return)`;
                    html += `</div>`;
                } else {
                    html += `<div class="explanation-result skip">`;
                    html += `<b>‚ùå TRADE SKIPPED ‚Äî ${t.skip_reason || 'Conditions not met'}</b><br><br>`;
                    html += `<span style="color: #cbd5e1;">The algorithm did NOT buy because one or more entry conditions failed. `;
                    if (skipReason.includes('VWAP')) {
                        html += `The price was below the average trading price, suggesting the stock was weak.`;
                    } else if (skipReason.includes('slope')) {
                        html += `The VWAP was trending downward, indicating sellers were in control.`;
                    } else if (skipReason.includes('stretch')) {
                        html += `The price had already run up too far from VWAP ‚Äî buying now would mean chasing.`;
                    } else if (skipReason.includes('mom')) {
                        html += `There wasn't enough upward momentum from the open to justify entry.`;
                    }
                    html += `</span></div>`;
                }

            } else if (isChatGPT) {
                const buyTrigger = p.buy_trigger_pct || 'N/A';
                const entryThreshold = t.open > 0 ? (t.open * (1 + buyTrigger / 100)).toFixed(2) : 'N/A';

                html += `<div class="explanation-section">`;
                html += `<div class="explanation-section-title">üìä Market Snapshot</div>`;
                html += `<div style="color: #e2e8f0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">`;
                html += `‚Ä¢ Stock opened at <b>$${open}</b><br>`;
                html += `‚Ä¢ By 10 AM, price was <b>$${price10am}</b> (${pctFrom10amToOpen >= 0 ? '+' : ''}${pctFrom10amToOpen}% from open)`;
                html += `</div></div>`;

                html += `<div class="explanation-section">`;
                html += `<div class="explanation-section-title">üéØ Entry Condition</div>`;
                const entryMet = t.price_10am >= t.open * (1 + buyTrigger / 100);
                html += `<div class="explanation-check ${entryMet ? 'pass' : 'fail'}">`;
                html += `<span style="font-size: 1.1rem;">${entryMet ? '‚úì' : '‚úó'}</span>`;
                html += `<div><b>10AM Price ‚â• +${buyTrigger}% above Open:</b><br>`;
                html += `Is $${price10am} ‚â• $${entryThreshold}? `;
                html += entryMet ? `<i>YES! Momentum confirmed ‚Äî buy signal triggered.</i>` : `<i>NO. Price didn't rise enough ‚Äî no entry.</i>`;
                html += `</div></div></div>`;

                if (t.bought) {
                    html += `<div class="explanation-result ${t.profit >= 0 ? 'win' : 'loss'}">`;
                    html += `<b>‚úÖ BOUGHT at $${price10am}</b> (10AM price)<br><br>`;
                    html += `<b>Exit Target:</b> Sell at +${sellTrigger}% from open ($${(t.open * (1 + sellTrigger / 100)).toFixed(2)})<br><br>`;
                    html += `<b>Result:</b> ${t.sold_at_target ? 'üéâ Hit target!' : 'Closed at end of day'} ‚Äî `;
                    html += `<b>${t.profit >= 0 ? '+' : ''}$${t.profit?.toFixed(0) || 0}</b>`;
                    html += `</div>`;
                } else {
                    html += `<div class="explanation-result skip">`;
                    html += `<b>‚ùå SKIPPED</b> ‚Äî Price didn't rise enough by 10AM to trigger entry.`;
                    html += `</div>`;
                }

            } else {
                const buyTrigger = p.buy_trigger_pct || 'N/A';
                const prevClose = t.prev_close?.toFixed(2) || 'N/A';

                html += `<div class="explanation-section">`;
                html += `<div class="explanation-section-title">üìä Market Snapshot</div>`;
                html += `<div style="color: #e2e8f0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">`;
                html += `‚Ä¢ Previous day closed at <b>$${prevClose}</b><br>`;
                html += `‚Ä¢ Today's high reached <b>$${t.high?.toFixed(2) || 'N/A'}</b>`;
                html += `</div></div>`;

                html += `<div class="explanation-section">`;
                html += `<div class="explanation-section-title">üéØ Entry Condition</div>`;
                html += `<div class="explanation-check ${t.bought ? 'pass' : 'fail'}">`;
                html += `<span style="font-size: 1.1rem;">${t.bought ? '‚úì' : '‚úó'}</span>`;
                html += `<div><b>Breakout:</b> Did price break +${buyTrigger}% above previous close?<br>`;
                html += t.bought ? `<i>YES! Breakout confirmed.</i>` : `<i>NO. Price didn't break out.</i>`;
                html += `</div></div></div>`;

                if (t.bought) {
                    html += `<div class="explanation-result ${t.profit >= 0 ? 'win' : 'loss'}">`;
                    html += `<b>‚úÖ BOUGHT on breakout</b><br>`;
                    html += `<b>Result:</b> <b>${t.profit >= 0 ? '+' : ''}$${t.profit?.toFixed(0) || 0}</b>`;
                    html += `</div>`;
                } else {
                    html += `<div class="explanation-result skip">`;
                    html += `<b>‚ùå SKIPPED</b> ‚Äî No breakout detected.`;
                    html += `</div>`;
                }
            }

            html += `</div>`;

            // Insert into the panel container
            const panelContainer = document.getElementById('trade-explanation-container');
            if (panelContainer) {
                panelContainer.innerHTML = html;
            }
        }

        function closeTradeExplanation() {
            const panelContainer = document.getElementById('trade-explanation-container');
            if (panelContainer) {
                panelContainer.innerHTML = '';
            }
            document.querySelectorAll('.trade-row.selected').forEach(row => row.classList.remove('selected'));
        }


        function renderAnalysisView() {
            const container = document.getElementById('analysis');
            if (!container) {
                console.error('Analysis container not found!');
                return;
            }
            const p = currentTradeLogMeta.params || {};
            const m = currentTradeLogMeta.metrics || {};
            const tradeLog = currentTradeLog || [];
            const startDate = currentTradeLogMeta.start_date || '';
            const endDate = currentTradeLogMeta.end_date || '';
            const dateRange = (startDate && endDate) ? `${startDate} ‚Üí ${endDate}` : '';

            // Check algorithm type - define OUTSIDE the if block so it's available everywhere
            const isChatGPT = tradeLog && tradeLog.length > 0 ? tradeLog.some(t => t.algo === 'chatgpt' || t.algo === 'chatgpt_stoploss' || t.algo === 'chatgpt_vwap' || t.price_10am != null) : (currentTradeLogMeta.algo === 'chatgpt' || currentTradeLogMeta.algo === 'chatgpt_stoploss' || currentTradeLogMeta.algo === 'chatgpt_vwap');
            const isStopLoss = tradeLog && tradeLog.length > 0 ? tradeLog.some(t => t.algo === 'chatgpt_stoploss' || t.algo === 'chatgpt_vwap' || t.exit_reason != null) : (currentTradeLogMeta.algo === 'chatgpt_stoploss' || currentTradeLogMeta.algo === 'chatgpt_vwap');
            const isVWAP = tradeLog && tradeLog.length > 0 ? tradeLog.some(t => t.algo === 'chatgpt_vwap' || t.vwap != null) : (currentTradeLogMeta.algo === 'chatgpt_vwap');
            const isDipper = tradeLog && tradeLog.length > 0 ? tradeLog.some(t => t.algo === 'default' || t.prev_close != null) : (currentTradeLogMeta.algo === 'default' || !currentTradeLogMeta.algo);

            // Store params and flags for the explanation panel click handler
            currentTradeParams = p;
            currentAlgoFlags = { isVWAP, isChatGPT, isStopLoss, isDipper };

            // Build trade log table HTML
            let tradeLogHtml = '';
            console.log('renderAnalysisView - tradeLog:', tradeLog, 'length:', tradeLog ? tradeLog.length : 0, 'isVWAP:', isVWAP, 'algo:', currentTradeLogMeta.algo);
            if (tradeLog && tradeLog.length > 0) {
                const sortIcon = (col) => tradeLogSortColumn === col ? (tradeLogSortAsc ? ' ‚ñ≤' : ' ‚ñº') : '';
                const thStyle = 'padding: 6px 8px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap;';
                const tdStyle = 'padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.05);';

                tradeLogHtml = `
                                    <div style="margin-top: 0.75rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                            <div style="color: var(--accent); font-weight: 600; font-size: 0.75rem;">
                                                üìä Trade Log with Buy/Sell Guidance <span style="color: var(--text-secondary); font-weight: 400; font-size: 0.65rem;">(${tradeLog.length} days) ${dateRange}</span>
                                                <span style="color: #94a3b8; font-weight: 400; font-size: 0.55rem; margin-left: 8px;">üëÜ Click any row to see detailed explanation</span>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem; font-size: 0.6rem;">
                                                <span style="background: ${currentTradeLogMeta.data_source === 'widesurf' ? '#a78bfa' : currentTradeLogMeta.data_source === 'massive' ? '#ffa500' : '#22c55e'}; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                                                    üì° ${currentTradeLogMeta.data_source === 'widesurf' ? 'Widesurf API' : currentTradeLogMeta.data_source === 'massive' ? 'Massive.com' : 'Alpaca API'}
                                                </span>
                                            </div>
                                        </div>
                                        <div id="trade-explanation-container"></div>
                                        <div style="max-height: 800px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px;">
                                            <table id="trade-log-table" style="width: 100%; font-size: 0.65rem; border-collapse: collapse;">
                                                <thead style="background: var(--bg-card); position: sticky; top: 0; z-index: 1;">
                                                    <tr>
                                                        <th style="${thStyle} text-align: left;" onclick="sortTradeLog('date')">Date${sortIcon('date')}</th>
                                                        <th style="${thStyle} text-align: center;" onclick="sortTradeLog('bought')">Buy?${sortIcon('bought')}</th>
                                                        <th style="${thStyle} text-align: right;" onclick="sortTradeLog('open')">Open${sortIcon('open')}</th>
                                                        ${isChatGPT ? `<th style="${thStyle} text-align: right;" onclick="sortTradeLog('price_10am')">10AM Price${sortIcon('price_10am')}</th>` : ''}
                                                        ${isChatGPT ? `<th style="${thStyle} text-align: right;" onclick="sortTradeLog('pct_change_10am')">10AM Œî %${sortIcon('pct_change_10am')}</th>` : ''}
                                                        ${isVWAP ? `<th style="${thStyle} text-align: right;" onclick="sortTradeLog('vwap')">VWAP${sortIcon('vwap')}</th>` : ''}
                                                        ${isVWAP ? `<th style="${thStyle} text-align: left; min-width: 90px;" onclick="sortTradeLog('skip_reason')">Skipped${sortIcon('skip_reason')}</th>` : ''}
                                                        ${isDipper && !isChatGPT ? `<th style="${thStyle} text-align: right;" onclick="sortTradeLog('prev_close')">Prev Close${sortIcon('prev_close')}</th>` : ''}
                                                        ${isDipper && !isChatGPT ? `<th style="${thStyle} text-align: right;" onclick="sortTradeLog('pct_change')">% Chg${sortIcon('pct_change')}</th>` : ''}
                                                        <th style="${thStyle} text-align: right;" onclick="sortTradeLog('close')">Close${sortIcon('close')}</th>
                                                        ${isStopLoss ? `<th style="${thStyle} text-align: right;">TP @</th>` : ''}
                                                        ${isStopLoss ? `<th style="${thStyle} text-align: right;">SL @</th>` : ''}
                                                        <th style="${thStyle} text-align: right;" onclick="sortTradeLog('sell_price')">Sell @${sortIcon('sell_price')}</th>
                                                        ${isStopLoss ? `<th style="${thStyle} text-align: center;">Exit</th>` : ''}
                                                        <th style="${thStyle} text-align: right;" onclick="sortTradeLog('profit')">Profit${sortIcon('profit')}</th>
                                                        <th style="${thStyle} text-align: right;" onclick="sortTradeLog('equity')">Equity${sortIcon('equity')}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${tradeLog.map((t, index) => `
                                        <tr class="trade-row" data-trade-index="${index}" onclick="showTradeExplanation(${index})" style="background: ${t.bought ? (t.sold_at_target ? 'rgba(0,200,100,0.15)' : 'rgba(0,200,100,0.08)') : 'transparent'};">
                                            <td style="${tdStyle} color: var(--text-secondary);">${t.date ? t.date.substring(0, 10) : ''}</td>
                                            <td style="${tdStyle} text-align: center;">${t.bought ? '‚úÖ' : '‚ùå'}</td>
                                            <td style="${tdStyle} text-align: right;">$${t.open?.toFixed(2) || 'N/A'}</td>
                                            ${isChatGPT ? `<td style="${tdStyle} text-align: right; color: var(--accent);">${t.price_10am ? '$' + t.price_10am.toFixed(2) : '‚Äî'}</td>` : ''}
                                            ${isChatGPT ? `<td style="${tdStyle} text-align: right; color: ${(t.pct_change_10am || 0) >= 0 ? 'var(--success)' : 'var(--danger)'};">${t.pct_change_10am != null ? ((t.pct_change_10am >= 0 ? '+' : '') + t.pct_change_10am.toFixed(2) + '%') : '‚Äî'}</td>` : ''}
                                            ${isVWAP ? `<td style="${tdStyle} text-align: right; color: #a78bfa;">${t.vwap ? '$' + t.vwap.toFixed(2) : '‚Äî'}</td>` : ''}
                                            ${isVWAP ? `<td style="${tdStyle} text-align: left; color: ${t.skip_reason ? '#f59e0b' : 'var(--success)'}; font-size: 0.6rem;">${t.skip_reason || (t.bought ? '$ ‚â• VWAP' : '‚Äî')}</td>` : ''}
                                            ${isDipper && !isChatGPT ? `<td style="${tdStyle} text-align: right;">$${t.prev_close?.toFixed(2) || 'N/A'}</td>` : ''}
                                            ${isDipper && !isChatGPT ? `<td style="${tdStyle} text-align: right; color: ${(t.pct_change || 0) >= 0 ? 'var(--success)' : 'var(--danger)'};">${t.pct_change != null ? ((t.pct_change >= 0 ? '+' : '') + t.pct_change.toFixed(2) + '%') : '‚Äî'}</td>` : ''}
                                            <td style="${tdStyle} text-align: right;">$${t.close?.toFixed(2) || 'N/A'}</td>
                                            ${isStopLoss ? `<td style="${tdStyle} text-align: right; color: var(--success); font-size: 0.6rem;">${t.bought && t.sell_price ? '$' + t.sell_price.toFixed(2) : '‚Äî'}</td>` : ''}
                                            ${isStopLoss ? `<td style="${tdStyle} text-align: right; color: var(--danger); font-size: 0.6rem;">${t.bought && t.stop_loss ? '$' + t.stop_loss.toFixed(2) : '‚Äî'}</td>` : ''}
                                            <td style="${tdStyle} text-align: right; color: ${t.sold_at_target ? 'var(--success)' : 'var(--text-secondary)'};">${t.bought ? (t.sold_at_target ? '$' + t.sell_price?.toFixed(2) + ' ‚úì' : '$' + (t.actual_sell?.toFixed(2) || t.close?.toFixed(2))) : '‚Äî'}</td>
                                            ${isStopLoss ? `<td style="${tdStyle} text-align: center; font-size: 0.6rem; font-weight: 600; color: ${t.exit_reason === 'TP' ? 'var(--success)' : t.exit_reason === 'SL' ? 'var(--danger)' : t.exit_reason === 'TRAIL' ? 'var(--accent)' : 'var(--text-secondary)'};">${t.exit_reason || '‚Äî'}</td>` : ''}
                                            <td style="${tdStyle} text-align: right; ${t.bought ? 'color: ' + ((t.profit || 0) >= 0 ? 'var(--success)' : 'var(--danger)') : 'color: #6b7280; opacity: 0.6;'};">
                                                ${t.bought
                        ? ((t.profit || 0) >= 0 ? '+' : '') + '$' + (t.profit?.toFixed(0) || 0)
                        : (() => {
                            // Calculate potential profit when not bought
                            const buyPrice = t.price_10am || t.open;
                            const sellPrice = t.sold_at_target ? t.sell_price : t.close;
                            if (buyPrice && sellPrice && buyPrice > 0) {
                                const potentialProfit = ((sellPrice - buyPrice) / buyPrice) * 100;
                                return (potentialProfit >= 0 ? '+' : '') + potentialProfit.toFixed(1) + '%';
                            }
                            return '‚Äî';
                        })()
                    }
                                            </td>
                                            <td style="${tdStyle} text-align: right; font-weight: 500;">$${t.equity?.toLocaleString() || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    `;
            } else {
                console.warn('No trade log data available. tradeLog length:', tradeLog.length, 'tradeLog:', tradeLog);
                tradeLogHtml = `
                                    <div style="margin-top: 0.75rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                                        <div style="color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Trade log not available</div>
                                        <div style="color: var(--text-secondary); font-size: 0.65rem;">
                                            Trade log data is missing for this run. This may happen if:<br>
                                                ‚Ä¢ The optimization was run before trade log generation was implemented<br>
                                                    ‚Ä¢ The trade log failed to save to the database<br>
                                                        ‚Ä¢ The data format is incompatible
                                                    </div>
                                                    <div style="margin-top: 0.5rem; font-size: 0.6rem; color: var(--text-secondary); font-family: monospace;">
                                                        Debug: tradeLog type=${typeof tradeLog}, length=${tradeLog ? tradeLog.length : 'null'}, algo=${currentTradeLogMeta.algo || 'N/A'}
                                                    </div>
                                                </div>
                                                `;
            }

            container.innerHTML = `
                                                <div style="padding: 0.5rem;">
                                                    <div style="color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                                        üìä ${currentTradeLogMeta.symbol} Optimization Analysis
                                                    </div>

                                                    <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(29, 155, 240, 0.1); border-radius: 6px;">
                                                        <div style="color: var(--text-secondary); font-size: 0.65rem; margin-bottom: 0.3rem;">Strategy:</div>
                                                        <div style="color: var(--text); font-size: 0.65rem; line-height: 1.4;">
                                                            ${isVWAP
                    ? `<b>Adaptive VWAP:</b> Buy @ 10AM if: price > VWAP ‚àß slope > 0 ‚àß stretch < 0.5√óvol ‚àß mom > 0.25√óvol ‚Üí TP @ <b>${p.sell_trigger_pct || 'N/A'}%</b> | SL @ Open`
                    : isChatGPT
                        ? `Buy @ 10AM if <b>+${p.buy_trigger_pct || 'N/A'}%</b> up from open ‚Üí Sell @ <b>+${p.sell_trigger_pct || 'N/A'}%</b> from open`
                        : `Buy @ <b>${p.buy_trigger_pct || 'N/A'}%</b> above prev close ‚Üí Sell @ <b>${p.sell_trigger_pct || 'N/A'}%</b> profit`} |
                                                            ${p.compound ? 'Compound' : 'Fixed'} | Win: <b>${m.win_rate ? (m.win_rate * 100).toFixed(0) + '%' : 'N/A'}</b>
                                                        </div>
                                                    </div>

                                                    ${tradeLogHtml}
                                                </div>
                                                `;
        }

        function sortTradeLog(column) {
            if (tradeLogSortColumn === column) {
                tradeLogSortAsc = !tradeLogSortAsc;
            } else {
                tradeLogSortColumn = column;
                tradeLogSortAsc = true;
            }

            currentTradeLog.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Handle booleans
                if (typeof valA === 'boolean') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                }

                // Handle nulls
                if (valA == null) valA = 0;
                if (valB == null) valB = 0;

                if (tradeLogSortAsc) {
                    return valA > valB ? 1 : valA < valB ? -1 : 0;
                } else {
                    return valA < valB ? 1 : valA > valB ? -1 : 0;
                }
            });

            renderAnalysisView();
        }

        // Format time as MM:SS or HH:MM:SS
        function formatTime(seconds) {
            if (seconds < 0 || !isFinite(seconds)) return '--:--';
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update elapsed time display
        function updateElapsedTime() {
            if (!globalProgress.startTime) return;
            const elapsed = (Date.now() - globalProgress.startTime) / 1000;
            document.getElementById('elapsed-time').textContent = formatTime(elapsed);
        }

        // Update global progress display
        function updateGlobalProgress() {
            const safeCompletedSymbols = Math.min(globalProgress.completedSymbols, globalProgress.totalSymbols || globalProgress.completedSymbols);
            const totalTrials = globalProgress.totalSymbols * globalProgress.trialsPerSymbol;
            const completedTrials = (safeCompletedSymbols * globalProgress.trialsPerSymbol) + globalProgress.currentSymbolTrials;
            const percent = totalTrials > 0 ? (completedTrials / totalTrials) * 100 : 0;

            document.getElementById('global-progress-fill').style.width = `${percent}%`;
            document.getElementById('global-progress-percent').textContent = `${Math.round(percent)}%`;
            document.getElementById('progress-stocks').textContent = `Stock ${safeCompletedSymbols + (globalProgress.currentSymbolTrials > 0 ? 1 : 0)}/${globalProgress.totalSymbols}`;
            document.getElementById('progress-trials').textContent = `Trial ${completedTrials}/${totalTrials}`;

            // Calculate speed and ETA
            if (globalProgress.startTime && completedTrials > 0) {
                const elapsedSecs = (Date.now() - globalProgress.startTime) / 1000;
                const speed = completedTrials / elapsedSecs;
                const remainingTrials = totalTrials - completedTrials;
                const etaSecs = speed > 0 ? remainingTrials / speed : 0;

                document.getElementById('trials-speed').textContent = `${speed.toFixed(1)} trials/s`;
                document.getElementById('remaining-time').textContent = formatTime(etaSecs);
            }
        }

        // Show global progress bar
        function showGlobalProgress(symbols, trialsPerSymbol) {
            globalProgress = {
                totalSymbols: symbols.length,
                completedSymbols: 0,
                trialsPerSymbol: trialsPerSymbol,
                currentSymbolTrials: 0,
                currentPhase: 'starting',  // Track current phase
                currentSymbol: '',
                startTime: Date.now(),
                timerInterval: setInterval(updateElapsedTime, 1000)
            };

            document.getElementById('global-progress').classList.add('active');
            // Start with loading animation
            const fillBar = document.getElementById('global-progress-fill');
            fillBar.style.width = '0%';
            fillBar.classList.add('loading');

            document.getElementById('global-progress-percent').textContent = '...';
            document.getElementById('elapsed-time').textContent = '00:00';
            // Estimate: ~0.2 seconds per trial (based on observed performance)
            const estimatedSeconds = Math.round(trialsPerSymbol * symbols.length * 0.2);
            const estMins = Math.floor(estimatedSeconds / 60);
            const estSecs = estimatedSeconds % 60;
            document.getElementById('remaining-time').textContent = `~${estMins}:${estSecs.toString().padStart(2, '0')}`;
            document.getElementById('trials-speed').textContent = '-- trials/s';
            document.getElementById('progress-stocks').textContent = `Stock 0/${symbols.length}`;
            document.getElementById('progress-trials').textContent = `Preparing ${symbols.length * trialsPerSymbol} trials...`;
            document.getElementById('iter-count').textContent = `0/${trialsPerSymbol}`;
        }

        // Hide global progress bar
        function hideGlobalProgress() {
            if (globalProgress.timerInterval) {
                clearInterval(globalProgress.timerInterval);
            }
            document.getElementById('global-progress').classList.remove('active');
            document.getElementById('global-progress-fill').classList.remove('loading');
        }

        // Load config from localStorage
        function loadConfig() {
            try {
                const saved = localStorage.getItem(CONFIG_KEY);
                if (saved) {
                    const config = JSON.parse(saved);
                    if (config.algo) {
                        document.getElementById('algo-select').value = config.algo;
                        onAlgoChange();
                    }
                    document.getElementById('symbols').value = config.symbols || 'TSLA';
                    document.getElementById('start-date').value = config.startDate || '2024-01-01';
                    document.getElementById('end-date').value = config.endDate || '2024-12-01';
                    document.getElementById('capital').value = config.capital || 100000;
                    document.getElementById('trials').value = config.trials || 200;
                    document.getElementById('metric').value = config.metric || 'sharpe';
                    document.getElementById('use-gpu').checked = config.useGpu !== undefined ? config.useGpu : true;
                    document.getElementById('smart-timing').checked = config.smartTiming || false;
                    document.getElementById('timing-approach').value = config.timingApproach || 'sequential';

                    // Show/hide timing approach based on smart timing setting
                    toggleTimingApproach();
                    log('Loaded saved configuration', 'info');
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        // Save config to localStorage
        function saveConfig() {
            try {
                const config = {
                    algo: document.getElementById('algo-select').value,
                    symbols: document.getElementById('symbols').value,
                    startDate: document.getElementById('start-date').value,
                    endDate: document.getElementById('end-date').value,
                    capital: document.getElementById('capital').value,
                    trials: document.getElementById('trials').value,
                    metric: document.getElementById('metric').value,
                    useGpu: document.getElementById('use-gpu').checked,
                    smartTiming: document.getElementById('smart-timing').checked,
                    timingApproach: document.getElementById('timing-approach').value
                };
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            } catch (e) {
                console.error('Failed to save config:', e);
            }
        }

        // Auto-save config on input change
        function setupConfigAutoSave() {
            const inputs = ['symbols', 'start-date', 'end-date', 'capital', 'trials', 'metric'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('change', saveConfig);
                document.getElementById(id).addEventListener('input', saveConfig);
            });
        }

        // Load history from database
        async function loadHistory() {
            const btn = document.querySelector('.refresh-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Loading...';
            btn.disabled = true;

            // Show loading state in history list
            document.getElementById('history-list').innerHTML =
                '<div class="empty-state" style="padding: 1rem;"><p>‚è≥ Loading history...</p></div>';

            try {
                // Load history and cached symbols list in parallel (non-blocking)
                // If cache symbols fails, history still loads (just without DB icons)
                const [historyResp, countResp] = await Promise.all([
                    fetch('/api/history'),
                    fetch('/api/history/count').then(r => r.json()).catch(e => ({ count: 0 })),
                    loadCachedSymbolsList().catch(e => console.warn('Cache symbols load failed (non-critical):', e))
                ]);
                if (!historyResp.ok) throw new Error(`HTTP ${historyResp.status}`);
                historyData = await historyResp.json();

                // Update counter with total from DB
                totalHistoryCount = countResp.count || historyData.length;
                document.getElementById('history-count').textContent = `(${totalHistoryCount})`;
                sortAndRenderHistory();
            } catch (e) {
                console.error('Failed to load history:', e);
                document.getElementById('history-list').innerHTML =
                    '<div class="empty-state" style="padding: 1rem; color: #ef4444;"><p>‚ùå Failed to load history</p><p style="font-size: 0.7rem; opacity: 0.7;">Check console for details. Click refresh to retry.</p></div>';
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Sort and render history
        function sortAndRenderHistory() {
            // Filter by search term first
            let filtered = historyData;
            if (searchFilter) {
                filtered = historyData.filter(item =>
                    item.symbol.toLowerCase().includes(searchFilter.toLowerCase())
                );
            }

            // Filter by GPU/CPU
            filtered = filtered.filter(item => {
                const isGpu = item.method === 'gpu_grid_search';
                if (isGpu && !showGpuRuns) return false;
                if (!isGpu && !showCpuRuns) return false;
                return true;
            });

            // Then sort
            let sorted = [...filtered];
            switch (currentSort) {
                case 'sharpe':
                    sorted.sort((a, b) => {
                        const aValue = a.sharpe_from_json ?? a.score ?? 0;
                        const bValue = b.sharpe_from_json ?? b.score ?? 0;
                        return bValue - aValue;
                    });
                    break;
                case 'max':
                    sorted.sort((a, b) => (b.volatility_max_gain || 0) - (a.volatility_max_gain || 0));
                    break;
                case 'win':
                    sorted.sort((a, b) => (b.win_rate || 0) - (a.win_rate || 0));
                    break;
                case 'fin':
                    // Sort by final equity or return % (since trade_log is not in list view)
                    sorted.sort((a, b) => (b.total_return || 0) - (a.total_return || 0));
                    break;
                case 'amnt':
                    // Sort by total trades metric
                    sorted.sort((a, b) => (b.total_trades || 0) - (a.total_trades || 0));
                    break;
                case 'win2':
                    // Use win_rate metric (trade_log calculation fallback is slow/offline)
                    sorted.sort((a, b) => (b.win_rate || 0) - (a.win_rate || 0));
                    break;
                case 'date':
                default:
                    sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }
            renderHistory(sorted);
        }

        // Filter history by search input
        function filterHistory() {
            searchFilter = document.getElementById('history-search').value;
            showGpuRuns = document.getElementById('filter-gpu').checked;
            showCpuRuns = document.getElementById('filter-cpu').checked;
            historyDisplayLimit = 30; // Reset pagination on filter change
            sortAndRenderHistory();
        }

        // Sort history by field
        function sortHistory(field) {
            currentSort = field;
            // Update button states
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`sort-${field}`).classList.add('active');
            sortAndRenderHistory();
        }

        // Render history list
        // Track which symbols have cached data
        let cachedSymbolsList = new Set();

        async function loadCachedSymbolsList() {
            try {
                const resp = await fetch('/api/price-cache');
                const data = await resp.json();
                if (data.cache) {
                    cachedSymbolsList = new Set(data.cache.map(c => c.symbol));
                }
            } catch (e) {
                console.error('Failed to load cached symbols list:', e);
            }
        }

        function renderHistory(history) {
            const container = document.getElementById('history-list');

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>No history yet</p></div>';
                return;
            }

            // Paginate: only show up to historyDisplayLimit items
            const displayedHistory = history.slice(0, historyDisplayLimit);
            const hasMore = history.length > historyDisplayLimit;
            const remaining = history.length - historyDisplayLimit;

            container.innerHTML = displayedHistory.map(item => {
                const sharpe = item.sharpe_from_json ?? item.score;
                const maxGain = item.volatility_max_gain;
                const isGpu = item.method === 'gpu_grid_search';
                const tradeLog = Array.isArray(item.trade_log) ? item.trade_log : [];
                const winRate = item.win_rate != null ? parseFloat(item.win_rate) : null;
                let totalTrades = null;
                let successfulTrades = null;

                // Prefer exact counts from trade log when available.
                if (tradeLog.length > 0) {
                    const executedTrades = tradeLog.filter(t => t && t.bought);
                    totalTrades = executedTrades.length;
                    successfulTrades = executedTrades.filter(t => (Number(t.profit) || 0) > 0).length;
                }

                // Fallback to aggregated metrics from history list endpoint.
                if (totalTrades === null && item.total_trades != null) {
                    const parsedTotal = Math.round(parseFloat(item.total_trades));
                    if (!Number.isNaN(parsedTotal) && parsedTotal >= 0) {
                        totalTrades = parsedTotal;
                    }
                    if (totalTrades !== null && winRate !== null && !Number.isNaN(winRate)) {
                        successfulTrades = Math.round(Math.max(0, Math.min(1, winRate)) * totalTrades);
                    }
                }

                const tradesDisplay =
                    (successfulTrades !== null && totalTrades !== null)
                        ? `${successfulTrades}/${totalTrades}`
                        : 'N/A';
                const gpuIcon = isGpu
                    ? '<span class="gpu-icon gpu" title="GPU Run">GPU</span>'
                    : '<span class="gpu-icon cpu" title="CPU Run">CPU</span>';
                const setIcon = item.smart_timing
                    ? '<span class="gpu-icon" style="background: linear-gradient(135deg, #9333ea, #7c3aed); margin-top: 2px;" title="Smart Entry Timing">SET</span>'
                    : '';
                const dbIcon = cachedSymbolsList.has(item.symbol.toUpperCase())
                    ? '<span class="gpu-icon" style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 2px;" title="Data Cached in DB">DB</span>'
                    : '';
                const algoName = item.algo === 'default' ? 'dipper' : (item.algo || 'dipper');
                const algoBadge = `<span style="font-size: 0.55rem; color: #ff6b6b; margin-left: 0.3rem; font-weight: 600;">${algoName}</span>`;
                return `
                                                <div class="history-item">
                                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                                        ${gpuIcon}
                                                        ${setIcon}
                                                        ${dbIcon}
                                                    </div>
                                                    <div class="history-item-content" onclick="showHistoryDetailById(${item.id})">
                                                        <div class="history-symbol">${item.symbol}${algoBadge}</div>
                                                        <div class="history-date">${formatDate(item.created_at)}</div>
                                                        <div class="history-score">
                                                            win: ${item.win_rate != null ? (parseFloat(item.win_rate) * 100).toFixed(0) + '%' : 'N/A'} |
                                                            ret: ${item.total_return != null ? (parseFloat(item.total_return) * 100).toFixed(1) + '%' : 'N/A'} |
                                                            fin: ${item.total_return != null ? ((parseFloat(item.total_return) + 1) * 100).toFixed(1) + '%' : 'N/A'} |
                                                            trades: ${tradesDisplay}
                                                        </div>
                                                        <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 2px;">
                                                            ${item.sharpe_from_json != null ? `sharpe: ${parseFloat(item.sharpe_from_json).toFixed(2)} | ` : ''}
                                                            ${item.volatility_max_gain != null ? `max: ${parseFloat(item.volatility_max_gain).toFixed(1)}%` : ''}
                                                        </div>
                                                    </div>
                                                    <button class="delete-btn" onclick="event.stopPropagation(); deleteHistoryItem(${item.id})" title="Delete">üóëÔ∏è</button>
                                                </div>
            `}).join('') + (hasMore ? `
                                                <button onclick="loadMoreHistory()" style="width: 100%; padding: 10px; margin-top: 8px; background: rgba(29, 155, 240, 0.2); border: 1px solid var(--accent); border-radius: 8px; color: var(--accent); cursor: pointer; font-size: 0.8rem;">
                                                    üìã Load More (${remaining} remaining)
                                                </button>
                                                ` : '');
        }

        // Load more history items
        function loadMoreHistory() {
            historyDisplayLimit += 30;
            sortAndRenderHistory();
        }

        // Delete history item
        async function deleteHistoryItem(id) {
            // Optimistic UI update - remove immediately
            historyData = historyData.filter(item => item.id !== id);
            totalHistoryCount = Math.max(0, totalHistoryCount - 1);
            document.getElementById('history-count').textContent = `(${totalHistoryCount})`;
            sortAndRenderHistory();

            // Delete in background
            fetch(`/api/history/${id}`, { method: 'DELETE' })
                .then(resp => {
                    if (resp.ok) {
                        log('Deleted history item', 'info');
                    } else {
                        log('Failed to delete item', 'error');
                        loadHistory(); // Reload if failed
                    }
                })
                .catch(e => {
                    log(`Delete error: ${e.message}`, 'error');
                    loadHistory(); // Reload if error
                });
        }

        // Delete all history items
        async function deleteAllHistory() {
            const count = historyData.length;
            if (count === 0) {
                log('No history to delete', 'info');
                return;
            }
            if (!confirm(`Are you sure you want to delete all ${count} history items? This cannot be undone.`)) {
                return;
            }
            try {
                const resp = await fetch('/api/history', { method: 'DELETE' });
                if (resp.ok) {
                    const data = await resp.json();
                    log(`Deleted ${data.deleted} history items`, 'success');
                    loadHistory();
                } else {
                    log('Failed to delete all history', 'error');
                }
            } catch (e) {
                log(`Delete all error: ${e.message}`, 'error');
            }
        }

        // Format date for display
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Show history detail by ID (uses local cache first for fast loading)
        async function showHistoryDetailById(id) {
            try {
                log(`Loading details for history #${id}...`, 'info');

                // Show immediately from local cache (fast - no network round trip)
                const cachedItem = historyData.find(h => h.id === id);
                if (cachedItem) {
                    showHistoryDetail({ ...cachedItem, trade_log: cachedItem.trade_log || [] });
                }

                // Fetch full details including trade_log in background
                const resp = await fetch(`/api/history/${id}`);
                if (!resp.ok) throw new Error('Failed to fetch details');
                const item = await resp.json();

                // Update with full data (includes trade_log for Analysis tab)
                showHistoryDetail(item);
            } catch (e) {
                log(`Failed to load history item: ${e.message}`, 'error');
                // If we already showed cached data, the user at least sees something
                if (!historyData.find(h => h.id === id)) {
                    log('No cached data available for this item', 'error');
                }
            }
        }

        // Show history detail in results panel
        function showHistoryDetail(item) {
            console.log('showHistoryDetail called with item:', item.symbol, 'trade_log:', item.trade_log ? item.trade_log.length : 0);
            const container = document.getElementById('results');
            container.innerHTML = '';

            // Store the item so the Apply button can reference it without inline JSON
            window._currentHistoryItem = item;

            const card = document.createElement('div');
            card.className = 'result-card complete';
            card.innerHTML = `
                                                <div class="result-header">
                                                    <span class="symbol-badge">${item.symbol}</span>
                                                    <span class="status-badge complete">History</span>
                                                </div>
                                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                                    Run on: ${formatDate(item.created_at)}<br>
                                                        Period: ${item.start_date || 'N/A'} to ${item.end_date || 'N/A'}
                                                </div>
                                                <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr);">
                                                    <div class="metric" style="background: linear-gradient(135deg, rgba(0,186,124,0.15), rgba(0,186,124,0.05)); border: 1px solid rgba(0,186,124,0.2);">
                                                        <div class="metric-label">Total Return</div>
                                                        <div class="metric-value ${item.total_return != null && parseFloat(item.total_return) > 0 ? 'positive' : 'negative'}">${item.total_return != null ? (parseFloat(item.total_return) * 100).toFixed(1) + '%' : 'N/A'}</div>
                                                    </div>
                                                    <div class="metric" style="background: linear-gradient(135deg, rgba(29,155,240,0.15), rgba(29,155,240,0.05)); border: 1px solid rgba(29,155,240,0.2);">
                                                        <div class="metric-label">Win Rate</div>
                                                        <div class="metric-value ${(item.win_rate != null && parseFloat(item.win_rate) > 0.5) ? 'positive' : ''}">${item.win_rate != null ? (parseFloat(item.win_rate) * 100).toFixed(0) + '%' : 'N/A'}</div>
                                                    </div>
                                                    <div class="metric" style="background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.2);">
                                                        <div class="metric-label">Final Equity</div>
                                                        <div class="metric-value" style="color: #a78bfa; font-size: 1rem;">${(() => { if (item.final_equity) return '$' + Math.round(item.final_equity).toLocaleString(); const tr = item.total_return != null ? parseFloat(item.total_return) : null; const cap = item.capital || 100000; return tr != null ? '$' + Math.round(cap * (1 + tr)).toLocaleString() : 'N/A'; })()}</div>
                                                    </div>
                                                </div>
                                                <div class="params-display" style="margin-top: 0.75rem;">
                                                    <div class="param">
                                                        <div class="param-label">Buy Trigger</div>
                                                        <div class="param-value">${item.buy_trigger_pct}%</div>
                                                    </div>
                                                    <div class="param">
                                                        <div class="param-label">Sell Trigger</div>
                                                        <div class="param-value">${item.sell_trigger_pct}%</div>
                                                    </div>
                                                    <div class="param">
                                                        <div class="param-label">Compound</div>
                                                        <div class="param-value">${item.compound ? 'Yes' : 'No'}</div>
                                                    </div>
                                                </div>
                                                <div class="metrics-grid" style="margin-top: 0.75rem; border-top: 1px solid var(--border); padding-top: 0.75rem; grid-template-columns: repeat(3, 1fr);">
                                                    <div class="metric">
                                                        <div class="metric-label">Algorithm</div>
                                                        <div class="metric-value" style="font-size: 0.7rem; color: #ff6b6b;">${(item.algo === 'default' ? 'Dipper' : (item.algo || 'Dipper')).replace('chatgpt_', '').replace('_', ' ').toUpperCase()}</div>
                                                    </div>
                                                    <div class="metric">
                                                        <div class="metric-label">Volatility</div>
                                                        <div class="metric-value" style="font-size: 0.85rem;">${sanitizeValue(item.volatility_avg_range, true, 2)}</div>
                                                    </div>
                                                    <div class="metric">
                                                        <div class="metric-label">Max Gain</div>
                                                        <div class="metric-value" style="font-size: 0.85rem;">${sanitizeValue(item.volatility_max_gain, true, 2)}</div>
                                                    </div>
                                                </div>
                                                <div class="metrics-grid" style="margin-top: 0.5rem; grid-template-columns: repeat(3, 1fr);">
                                                    <div class="metric">
                                                        <div class="metric-label">Duration</div>
                                                        <div class="metric-value" style="color: var(--accent); font-size: 0.85rem;">‚è±Ô∏è ${item.duration_seconds ? (item.duration_seconds >= 60 ? Math.floor(item.duration_seconds / 60) + 'm ' + Math.round(item.duration_seconds % 60) + 's' : item.duration_seconds + 's') : 'N/A'}</div>
                                                    </div>
                                                    <div class="metric">
                                                        <div class="metric-label">Trials</div>
                                                        <div class="metric-value" style="font-size: 0.85rem;">${item.n_trials || item.trials_count || 200}</div>
                                                    </div>
                                                    <div class="metric">
                                                        <div class="metric-label">Capital</div>
                                                        <div class="metric-value" style="font-size: 0.85rem;">$${(item.capital || 0).toLocaleString()}</div>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-input); border-radius: 6px; font-size: 0.7rem; color: var(--text-secondary);">
                                                    üìÖ Optimized: ${item.start_date || 'N/A'} ‚Üí ${item.end_date || 'N/A'}
                                                    ${item.backtest_start_date ? '<br>üìä Backtest: ' + item.backtest_start_date + ' ‚Üí ' + (item.backtest_end_date || 'N/A') : ''}
                                                </div>
                                                <button class="btn btn-primary" style="margin-top: 0.75rem; width: 100%;" onclick="applyHistoryConfig(window._currentHistoryItem)">
                                                Apply These Settings
                                            </button>
                                            `;
            container.appendChild(card);

            // Update Analysis tab with this history item's data
            // Ensure trade_log is an array
            let tradeLog = item.trade_log || [];
            console.log('showHistoryDetail - item.trade_log type:', typeof item.trade_log, 'isArray:', Array.isArray(tradeLog));

            if (!Array.isArray(tradeLog)) {
                console.log('trade_log is not an array, attempting to parse...');
                try {
                    if (typeof tradeLog === 'string') {
                        tradeLog = JSON.parse(tradeLog);
                    } else if (tradeLog && typeof tradeLog === 'object') {
                        // Might be a dict/object, try to convert
                        tradeLog = Object.values(tradeLog);
                    } else {
                        tradeLog = [];
                    }
                    console.log('Parsed trade_log, new length:', tradeLog.length);
                } catch (e) {
                    console.error('Failed to parse trade_log:', e, 'tradeLog:', tradeLog);
                    tradeLog = [];
                }
            }

            console.log('Calling updateAnalysisView with tradeLog length:', tradeLog.length, 'algo:', item.algo);

            updateAnalysisView({
                symbol: item.symbol,
                n_trials: item.n_trials,
                optimized_for: item.optimized_for || 'sharpe',
                duration_seconds: item.duration_seconds,
                start_date: item.start_date,
                end_date: item.end_date,
                algo: item.algo || 'default',
                best_params: {
                    buy_trigger_pct: item.buy_trigger_pct,
                    sell_trigger_pct: item.sell_trigger_pct,
                    compound: item.compound
                },
                volatility_profile: {
                    volatility_score: item.volatility_score,
                    avg_daily_range: item.volatility_avg_range,
                    max_daily_gain: item.volatility_max_gain
                },
                metrics: {
                    win_rate: item.win_rate
                },
                trade_log: tradeLog
            });
            switchLogTab('analysis');

            log(`Showing history for ${item.symbol} from ${formatDate(item.created_at)}`, 'info');
        }

        // Open analysis in new tab
        function openAnalysis(symbol, historyId) {
            const analysisUrl = `/api/analysis/${historyId}`;
            window.open(analysisUrl, '_blank');
        }

        // Apply history config to form
        function applyHistoryConfig(item) {
            document.getElementById('symbols').value = item.symbol;
            if (item.start_date) document.getElementById('start-date').value = item.start_date;
            if (item.end_date) document.getElementById('end-date').value = item.end_date;
            // Load backtest dates - use optimization dates as fallback
            document.getElementById('backtest-start-date').value = item.backtest_start_date || item.start_date || '';
            document.getElementById('backtest-end-date').value = item.backtest_end_date || item.end_date || '';
            if (item.capital) document.getElementById('capital').value = item.capital;
            if (item.n_trials) document.getElementById('trials').value = item.n_trials;
            if (item.optimized_for) document.getElementById('metric').value = item.optimized_for;
            // Set algo dropdown if available
            if (item.algo) document.getElementById('algo-select').value = item.algo;
            // Set API data source dropdown (alpaca or widesurf)
            if (item.data_source) document.getElementById('data-source').value = item.data_source;
            // Set GPU checkbox based on how this run was executed
            const wasGpuRun = item.method === 'gpu_grid_search';
            document.getElementById('use-gpu').checked = wasGpuRun;
            onAlgoChange(); // Update algo description
            saveConfig();
            log(`Applied settings from ${item.symbol} history (Algo: ${item.algo || 'default'}, Data: ${item.data_source || 'alpaca'})`, 'success');
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                document.getElementById('ws-status').classList.add('connected');
                document.getElementById('ws-text').textContent = 'Connected';
                log('Connected to optimizer server', 'success');
            };

            ws.onclose = () => {
                document.getElementById('ws-status').classList.remove('connected');
                document.getElementById('ws-text').textContent = 'Disconnected';
                log('Disconnected from server', 'error');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
        }

        function handleMessage(data) {
            // Feed all messages to live log in Logs tab
            if (data.message) {
                const logType = data.type === 'error' ? 'error' : data.type === 'warning' ? 'warning'
                    : (data.type === 'complete' || data.type === 'job_complete') ? 'success' : 'info';
                appendToLiveLog(data.message, logType);
            }

            switch (data.type) {
                case 'status':
                    updateStatus(data);
                    break;
                case 'progress':
                    updateProgress(data);
                    break;
                case 'job_progress':
                    updateJobProgress(data);
                    break;
                case 'warning':
                    showWarning(data);
                    break;
                case 'complete':
                    showComplete(data);
                    break;
                case 'stock_complete':
                    showComplete(data);
                    break;
                case 'error':
                    showError(data);
                    break;
                case 'job_complete':
                case 'optimization_complete':
                    log('All optimizations complete!', 'success');
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('partial-btn').disabled = false;
                    document.getElementById('start-btn').textContent = 'Start Optimization';
                    document.getElementById('partial-btn').textContent = 'üß© Partial Optimization';
                    activeJobIds = [];
                    hideGlobalProgress();
                    loadHistory();
                    // Refresh job list in Logs tab
                    _jobDetailCache && Object.keys(_jobDetailCache).forEach(k => delete _jobDetailCache[k]);
                    if (document.getElementById('logs-panel').style.display !== 'none') loadJobLogs();
                    break;
            }
        }

        function showWarning(data) {
            if (!window.dataRangeWarnings) window.dataRangeWarnings = {};
            window.dataRangeWarnings[data.symbol] = data.message;

            const card = document.getElementById(`card-${data.symbol}`);
            if (!card) return;

            // Extract actual start date from message like "Data only available from 2024-01-21..."
            const dateMatch = data.message.match(/from (\d{4}-\d{2}-\d{2})/);
            const actualStart = dateMatch ? dateMatch[1] : null;

            let warningEl = card.querySelector('.data-range-warning');
            if (!warningEl) {
                warningEl = document.createElement('div');
                warningEl.className = 'data-range-warning';
                warningEl.style.cssText = 'background: rgba(29,155,240,0.08); border-left: 3px solid var(--accent); border-radius: 4px; padding: 5px 10px; margin: 6px 0; font-size: 0.72rem; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;';
                const paramsDisplay = card.querySelector('.params-display');
                if (paramsDisplay) card.insertBefore(warningEl, paramsDisplay);
                else card.appendChild(warningEl);
            }

            const autoFixBtn = actualStart
                ? `<button onclick="document.getElementById('start-date').value='${actualStart}'" style="background:transparent;border:1px solid var(--accent);color:var(--accent);border-radius:3px;padding:1px 6px;font-size:0.68rem;cursor:pointer;white-space:nowrap;">Auto-fix</button>`
                : '';
            warningEl.innerHTML = `<span>üìÖ Data starts ${actualStart || 'later than requested'}</span>${autoFixBtn}`;
        }

        function updateStatus(data) {
            log(`[${data.symbol}] ${data.message}`, 'info');
            ensureCard(data.symbol, 'optimizing');

            // Track current phase for progress display
            globalProgress.currentSymbol = data.symbol;
            globalProgress.currentPhase = data.status;

            // Update the trials display based on phase
            const phaseMessages = {
                'downloading_data': `‚¨áÔ∏è Downloading missing data for ${data.symbol}...`,
                'fetching_data': `üì• Using cached data for ${data.symbol}...`,
                'fetching_vwap_data': `üìä Fetching VWAP & 10AM prices...`,
                'processing_vwap': `üìä Processing VWAP data...`,
                'analyzing': `üî¨ Analyzing ${data.symbol} volatility...`,
                'optimizing': `üß† Optimizing ${data.symbol}...`,
                'optimizing_gpu': `üî• GPU optimizing ${data.symbol}...`,
                'optimizing_cpu': `ü¶Ä CPU optimizing ${data.symbol}...`,
                'optimizing_parallel': `ü¶Ä Parallel optimizing ${data.symbol}...`,
                'optimizing_timing': `‚è∞ Finding optimal buy time...`,
                'generating_trade_log': `üìù Generating trade log...`,
                'saving_to_db': `üíæ Saving results to database...`
            };

            // Short phase names for stats bar (always update)
            const shortPhaseNames = {
                'fetching_data': 'üì• Fetch',
                'fetching_vwap_data': 'üìä VWAP',
                'processing_vwap': 'üìä VWAP Done',
                'analyzing': 'üî¨ Analyze',
                'optimizing': 'üß† Optimize',
                'optimizing_gpu': 'üî• GPU',
                'optimizing_cpu': 'ü¶Ä CPU',
                'optimizing_parallel': 'ü¶Ä Parallel',
                'optimizing_timing': '‚è∞ Timing',
                'generating_trade_log': 'üìù TradeLog',
                'saving_to_db': 'üíæ Saving'
            };

            // Always update phase status
            if (shortPhaseNames[data.status]) {
                document.getElementById('phase-status').textContent = shortPhaseNames[data.status];
            }

            if (phaseMessages[data.status]) {
                document.getElementById('progress-trials').textContent = phaseMessages[data.status];
                document.getElementById('progress-stocks').textContent =
                    `Stock ${globalProgress.completedSymbols + 1}/${globalProgress.totalSymbols}`;
            }

            const card = document.getElementById(`card-${data.symbol}`);
            if (card) {
                const status = card.querySelector('.status-badge');
                status.textContent = data.status;

                if (data.volatility) {
                    const info = card.querySelector('.volatility-info');
                    if (info) {
                        info.innerHTML = `
              <div class="metric"><div class="metric-label">Avg Range</div><div class="metric-value">${data.volatility.avg_range}%</div></div>
              <div class="metric"><div class="metric-label">Max Gain</div><div class="metric-value">${data.volatility.max_gain}%</div></div>
              <div class="metric"><div class="metric-label">Volatility</div><div class="metric-value">${data.volatility.volatility_score}</div></div>
            `;
                    }
                }
            }
        }

        function updateProgress(data) {
            const card = document.getElementById(`card-${data.symbol}`);
            if (card) {
                const progress = (data.trials_completed / data.total_trials) * 100;
                const bar = card.querySelector('.progress-bar-fill');
                if (bar) bar.style.width = `${progress}%`;

                const statusText = card.querySelector('.progress-text');
                if (statusText) {
                    statusText.textContent = `Trial ${data.trials_completed}/${data.total_trials} | Best: ${data.best_score?.toFixed(2) || '--'}`;
                }

                if (data.best_params) {
                    const params = card.querySelector('.current-params');
                    if (params) {
                        params.innerHTML = `
              <div class="param"><div class="param-label">Buy Trigger</div><div class="param-value">${data.best_params.buy_trigger?.toFixed(1) || '--'}%</div></div>
              <div class="param"><div class="param-label">Sell Trigger</div><div class="param-value">${data.best_params.sell_trigger?.toFixed(1) || '--'}%</div></div>
            `;
                    }
                }
            }

            // Update global progress
            globalProgress.currentSymbolTrials = data.trials_completed;
            // Update trialsPerSymbol if this stock has different total (e.g., GPU mode)
            if (data.total_trials && data.total_trials !== globalProgress.trialsPerSymbol) {
                globalProgress.trialsPerSymbol = data.total_trials;
            }

            // Remove loading animation once trials start
            const fillBar = document.getElementById('global-progress-fill');
            if (fillBar.classList.contains('loading')) {
                fillBar.classList.remove('loading');
            }

            // Update the trials display to show actual trial count
            const totalTrials = globalProgress.totalSymbols * globalProgress.trialsPerSymbol;
            const completedTrials = (globalProgress.completedSymbols * globalProgress.trialsPerSymbol) + data.trials_completed;
            document.getElementById('progress-trials').textContent = `Trial ${completedTrials}/${totalTrials}`;
            document.getElementById('iter-count').textContent = `${data.trials_completed}/${data.total_trials || globalProgress.trialsPerSymbol}`;

            // Update phase status based on progress phase
            const phaseMap = {
                'gpu_preparing': '‚è≥ Preparing',
                'gpu_optimizing': 'üî• Grid Search',
                'gpu_complete': '‚è≥ Post-process...'  // Changed from Complete to indicate more work
            };
            if (data.phase && phaseMap[data.phase]) {
                document.getElementById('phase-status').textContent = phaseMap[data.phase];

                // When grid search completes, show estimated post-processing time
                if (data.phase === 'gpu_complete') {
                    document.getElementById('remaining-time').textContent = '~0:30';  // ~30s for post-process
                    document.getElementById('progress-trials').textContent = 'Grid search done, generating trade log...';
                }
            }

            // Update percentage (cap at 95% until truly complete to show post-processing remaining)
            const rawPercent = totalTrials > 0 ? (completedTrials / totalTrials) * 100 : 0;
            const percent = data.phase === 'gpu_complete' ? 95 : Math.min(rawPercent * 0.9, 95);  // Reserve 5% for post-processing
            fillBar.style.width = `${percent}%`;
            document.getElementById('global-progress-percent').textContent = `${Math.round(percent)}%`;

            updateGlobalProgress();
        }

        function updateJobProgress(data) {
            // Only track progress for currently active jobs
            if (data.job_id && activeJobIds.length > 0 && !activeJobIds.includes(data.job_id)) return;

            hasJobProgressUpdates = true;
            const isPrefetchPhase = (typeof data.message === 'string' && data.message.includes('Downloaded data'));

            if (Number.isFinite(data.total) && data.total > 0) {
                globalProgress.totalSymbols = data.total;
            }

            if (!isPrefetchPhase && Number.isFinite(data.completed) && data.completed >= 0) {
                globalProgress.completedSymbols = Math.min(data.completed, globalProgress.totalSymbols || data.completed);
                // job_progress is symbol-level completion, so reset per-symbol trial progress
                globalProgress.currentSymbolTrials = 0;
            }

            document.getElementById('phase-status').textContent = isPrefetchPhase ? 'üì• Prefetch' : '‚öôÔ∏è Batch';
            updateGlobalProgress();

            if (data.message) {
                document.getElementById('progress-trials').textContent = data.message;
            }
        }

        function showComplete(data) {
            // Only count completions from current job
            if (data.job_id && !activeJobIds.includes(data.job_id)) return;

            log(`[${data.symbol}] Optimization complete!`, 'success');
            if (data.result) {
                results[data.symbol] = data.result;
            }

            // If backend does not emit job_progress, fall back to per-symbol completion counting
            if (!hasJobProgressUpdates && data.symbol && !finalizedSymbols.has(data.symbol)) {
                finalizedSymbols.add(data.symbol);
                globalProgress.completedSymbols++;
                globalProgress.currentSymbolTrials = 0;
                updateGlobalProgress();
            }

            const card = document.getElementById(`card-${data.symbol}`);
            if (card) {
                card.classList.remove('optimizing');
                card.classList.add('complete');

                const status = card.querySelector('.status-badge');
                status.textContent = 'Complete';
                status.classList.remove('optimizing');
                status.classList.add('complete');

                const bar = card.querySelector('.progress-bar-fill');
                if (bar) bar.style.width = '100%';

                const params = card.querySelector('.current-params');
                const r = data.result;
                if (params) {
                    const algoType = r.algo || document.getElementById('algo-select').value;
                    const isVWAP = algoType && algoType.includes('vwap');
                    params.innerHTML = `
                                            <div class="param"><div class="param-label">Buy Trigger</div><div class="param-value">${r.best_params.buy_trigger_pct}%</div></div>
                                            <div class="param"><div class="param-label">Sell Trigger</div><div class="param-value">${r.best_params.sell_trigger_pct}%</div></div>
                                            <div class="param"><div class="param-label">Compound</div><div class="param-value">${r.best_params.compound ? 'Yes' : 'No'}</div></div>
                                            `;
                }

                const metrics = card.querySelector('.result-metrics');
                if (metrics) {
                    const metricType = document.getElementById('metric').value;
                    const score = r.metrics[metricType];
                    const winRate = r.metrics.win_rate;
                    const duration = r.duration_seconds || 0;
                    const durationText = duration >= 60 ? `${Math.floor(duration / 60)}m ${Math.round(duration % 60)}s` : `${duration.toFixed(1)}s`;
                    const sanitizedScore = sanitizeValue(score, false, 2);
                    const winRateDisplay = (winRate != null && winRate !== -999999 && !isNaN(winRate)) ? `${(winRate * 100).toFixed(0)}%` : 'N/A';
                    const showWinRate = metricType !== 'win_rate';
                    metrics.innerHTML = `
                                            <div class="metric"><div class="metric-label">${metricType}</div><div class="metric-value ${(score != null && score !== -999999 && score > 0) ? 'positive' : 'negative'}">${sanitizedScore}</div></div>
                                            ${showWinRate ? `<div class="metric"><div class="metric-label">Win %</div><div class="metric-value ${(winRate != null && winRate > 0.5) ? 'positive' : ''}">${winRateDisplay}</div></div>` : ''}
                                            <div class="metric"><div class="metric-label">Duration</div><div class="metric-value" style="color: var(--accent);">‚è±Ô∏è ${durationText}</div></div>
                                            `;
                }
            }

            // Update Analysis tab with detailed results
            updateAnalysisView({
                symbol: data.symbol,
                n_trials: data.result.n_trials || data.result.trials_count,
                optimized_for: document.getElementById('metric').value,
                duration_seconds: data.result.duration_seconds,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value,
                best_params: data.result.best_params,
                volatility_profile: data.result.volatility_profile,
                metrics: data.result.metrics,
                trade_log: data.result.trade_log
            });
            switchLogTab('analysis');

            // Add to history list immediately without full reload
            if (data.result.history_id) {
                const r = data.result;
                const m = r.metrics || {};
                const p = r.best_params || {};
                const v = r.volatility_profile || {};

                const newHistoryItem = {
                    id: r.history_id,
                    symbol: data.symbol,
                    algo: r.algo || document.getElementById('algo-select').value,
                    created_at: new Date().toISOString(),
                    method: r.method || 'cpu_parallel',
                    win_rate: m.win_rate != null ? m.win_rate : null,
                    total_return: m.total_return != null ? m.total_return : null,
                    score: m[document.getElementById('metric').value] || 0,
                    buy_trigger_pct: p.buy_trigger_pct,
                    sell_trigger_pct: p.sell_trigger_pct,
                    stop_loss_pct: p.stop_loss_pct,
                    compound: p.compound,
                    optimized_for: r.optimized_for || document.getElementById('metric').value,
                    volatility_avg_range: v.avg_daily_range || 0,
                    volatility_max_gain: v.max_daily_gain || 0,
                    volatility_score: v.volatility_score || 0,
                    capital: parseInt(document.getElementById('capital').value) || 100000,
                    trade_log: r.trade_log,
                    start_date: r.requested_start_date || document.getElementById('start-date').value,
                    end_date: r.requested_end_date || document.getElementById('end-date').value,
                    backtest_start_date: r.backtest_start_date,
                    backtest_end_date: r.backtest_end_date,
                    duration_seconds: r.duration_seconds,
                    smart_timing: r.optimal_buy_time_cdt ? true : false
                };

                // Remove if already exists (avoids duplicates if backend saved it)
                const exists = historyData.some(item => (item.symbol === data.symbol && item.job_id === data.job_id));
                historyData = historyData.filter(item => !(item.symbol === data.symbol && item.job_id === data.job_id));

                if (!exists) {
                    totalHistoryCount++;
                }

                historyData.unshift(newHistoryItem);  // Add to front of list
                document.getElementById('history-count').textContent = `(${totalHistoryCount})`;
                sortAndRenderHistory();  // Re-render the list
            }
        }

        function showError(data) {
            log(`[${data.symbol}] Error: ${data.message}`, 'error');
            const card = document.getElementById(`card-${data.symbol}`);
            if (card) {
                card.classList.add('error');
                const status = card.querySelector('.status-badge');
                status.textContent = 'Error';
            }

            // If backend does not emit job_progress, count failed symbols so global stock counter doesn't freeze
            if (!hasJobProgressUpdates && data.symbol && !finalizedSymbols.has(data.symbol)) {
                finalizedSymbols.add(data.symbol);
                globalProgress.completedSymbols = Math.min(globalProgress.completedSymbols + 1, globalProgress.totalSymbols);
                globalProgress.currentSymbolTrials = 0;
                updateGlobalProgress();
            }
        }

        function ensureCard(symbol, status) {
            if (document.getElementById(`card-${symbol}`)) return;

            const container = document.getElementById('results');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const card = document.createElement('div');
            card.id = `card-${symbol}`;
            card.className = `result-card ${status}`;
            card.innerHTML = `
                                            <div class="result-header">
                                                <span class="symbol-badge">${symbol}</span>
                                                <span class="status-badge ${status}">Starting</span>
                                            </div>
                                            <div class="progress-bar"><div class="progress-bar-fill" style="width: 0%"></div></div>
                                            <div class="progress-text" style="font-size: 0.75rem; color: var(--text-secondary);">Initializing...</div>
                                            <div class="metrics-grid volatility-info"></div>
                                            <div class="params-display current-params">
                                                <div class="param"><div class="param-label">Buy Trigger</div><div class="param-value">--</div></div>
                                                <div class="param"><div class="param-label">Sell Trigger</div><div class="param-value">--</div></div>
                                            </div>
                                            <div class="metrics-grid result-metrics"></div>
                                            `;
            container.appendChild(card);
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // SPY 500 Stock List (top 300+ most liquid stocks)
        const SPY_500_STOCKS = 'NVDA,AAPL,GOOG,GOOGL,MSFT,AMZN,AVGO,META,TSLA,BRK.B,WMT,LLY,JPM,V,ORCL,JNJ,MA,XOM,PLTR,NFLX,BAC,ABBV,COST,AMD,HD,PG,CSCO,UNH,GE,CVX,KO,CAT,WFC,IBM,MU,MS,GS,AXP,CRM,MRK,APP,RTX,PM,MCD,TMUS,TMO,AMAT,ABT,LRCX,PEP,C,DIS,ISRG,QCOM,GEV,BX,INTC,LIN,INTU,NOW,BLK,UBER,TJX,SCHW,T,AMGN,APH,BKNG,VZ,ANET,NEE,ACN,TXN,DHR,KLAC,GILD,BA,COF,SPGI,PFE,ADBE,UNP,LOW,ADI,ETN,BSX,PGR,SYK,PANW,CRWD,DE,MDT,KKR,WELL,PLD,HON,CB,COP,CEG,PH,VRTX,HOOD,HCA,LMT,NEM,ADP,BMY,CVS,MCK,CMCSA,NKE,MO,CME,DASH,SBUX,SO,ICE,GD,DELL,CDNS,SNPS,MMC,MMM,TT,DUK,APO,MCO,WM,UPS,AMT,USB,PNC,BK,GLW,SHW,ELV,NOC,MAR,ORLY,HWM,EMR,ABNB,REGN,RCL,CTAS,GM,ITW,AON,WMB,TDG,EQIX,ECL,WBD,CI,COIN,CMI,JCI,TEL,MNST,PWR,MDLZ,CSX,FCX,SPG,FDX,STX,COR,NSC,RSG,HLT,WDC,ADSK,AJG,TFC,TRV,CL,FTNT,MSI,AEP,SLB,KMI,EOG,PCAR,ROST,VST,WDAY,NXPI,SRE,PSX,PYPL,AZO,BDX,AFL,IDXX,MPC,DLR,F,APD,LHX,MET,ALL,NDAQ,URI,O,DDOG,VLO,ZTS,EA,D,GWW,EW,PSA,ROP,FAST,CAH,CBRE,MPWR,AME,BKR,ROK,OKE,AMP,CMG,AXON,DAL,CARR,DHI,FANG,TTWO,LVS,AIG,CTVA,XEL,TGT,EXC,FICO,ETR,MSCI,PAYX,YUM,PRU,OXY,GRMN,CTSH,A,KDP,CCI,KR,TRGP,TKO,VMC,PEG,GEHC,XYZ,IQV,EBAY,NUE,MLM,EL,HIG,CPRT,MCHP,WAB,HSY,RMD,KEYS,FISV,VTR,CCL,STT,SYY,SNDK,UAL,EQT,FIS,ED,EXPE,KMB,OTIS,XYL,ACGL,WEC,ODFL,KVUE,IR,LYV,NRG,PCG,HPE,RJF,HUM,FITB,TER,FOXA,MTB,WTW,CHTR,SYF,VRSK,VICI,FOX,EXR,LEN,IBKR,FSLR,DG,MTD,KHC,ADM,EME,ROL,CSGP,HBAN,DOV,TSCO,EXE,BRO,DTE,BR,ATO,EFX,DXCM,NTRS,WRB,ULTA,AEE,CBOE,STZ,IRM,DLTR,CINF,FE,AWK,ES,OMC,BIIB,TPR,STLD,CFG,JBL,AVB,PHM,STE,PPL,GIS,HUBB,TDY,VLTO,HAL,RF,CNP,LDOS,EQR,NTAP,DVN,WAT,HPQ,PPG,TROW,VRSN,KEY,WSM,ON,RL,EIX,LULU,CPAY,LH,L,NVR,DRI,PTC,CMS,LUV,TSN,PODD,IP,SBAC,EXPD,TPL,SMCI,DGX,CTRA,PFG,CHD,NI,CNC,TRMB,SW,WST,TYL,CDW,GPN,AMCR,JBHT,CHRW,INCY,GPC,PKG,ZBH,SNA,LII,BG,TTD,Q,MKC,FTV,DOW,DD,PNR,APTV,ESS,GEN,GDDY,EVRG,IT,WY,LNT,HOLX,INVH,J,IFF,COO,MAA,ALB,BBY,PSKY,FFIV,TXT,NWS,DECK,DPZ,ERIE,NWSA,LYB,SOLV,ALLE,AVY,UHS,ZBRA,KIM,EG,IEX,JKHY,MAS,VTRS,BALL,NDSN,HRL,UDR,WYNN,HII,BXP,HST,REG,CLX,AKAM,CF,BEN,BLDR,IVZ,SWK,DOC,HAS,RVTY,ALGN,EPAM,MRNA,AIZ,CPT,GL,DAY,FDS,SJM,PNW,MGM,SWKS,AES,GNRC,BAX,CRL,AOS,TECH,NCLH,TAP,APA,PAYC,HSIC,POOL,MOH,FRT,DVA,CPB,CAG,LW,MOS,SOLS,LKQ,ARE,MTCH,MHK'.split(',');

        // FULL Stock List - Comprehensive list including extended sectors (400+ stocks)
        const FULL_STOCK_LIST = 'AAPL,MSFT,GOOGL,GOOG,AMZN,NVDA,META,TSLA,BRK.B,BRK.A,JPM,V,JNJ,UNH,HD,PG,MA,XOM,LLY,AVGO,CVX,MRK,COST,ABBV,PEP,KO,ORCL,CRM,ADBE,AMD,NFLX,TMO,WMT,DIS,ACN,LIN,MCD,CSCO,ABT,TXN,DHR,INTU,CAT,VZ,CMCSA,NEE,BAC,WFC,PM,UPS,RTX,IBM,MS,PFE,INTC,LOW,UNP,AMGN,SPGI,GS,AXP,BLK,ISRG,QCOM,AMAT,DE,GE,NKE,MDT,ADI,LMT,SBUX,PLD,CB,CVS,MMC,TGT,MO,CI,BDX,ZTS,EL,DUK,SO,EQIX,ICE,SHW,CL,ITW,PNC,APD,GM,FDX,HUM,AON,EMR,ECL,ETN,EW,ROP,TRV,VRTX,PSA,NSC,PH,SLB,MCO,ORLY,GILD,REGN,BIIB,MRNA,KLAC,LRCX,CDNS,SNPS,FTNT,PAYX,ADP,CTAS,ROST,ODFL,EXC,XEL,WM,CSX,KMB,COF,MSI,ILMN,DXCM,IDXX,FAST,KR,PPG,ALL,PRU,AIG,STZ,PEG,WEC,ED,ES,HPQ,DELL,HPE,ANET,NET,DDOG,SNOW,CRWD,ZS,PANW,OKTA,TEAM,HUBS,SHOP,EBAY,ETSY,PINS,SNAP,ROKU,SPOT,UBER,LYFT,DASH,ABNB,BKNG,EXPE,MAR,HLT,RCL,CCL,NCLH,UAL,DAL,AAL,LUV,JBLU,ALK,BA,TXT,SPR,GD,NOC,HII,LHX,TDG,HEI,MTZ,PWR,URI,WSM,BBY,GPC,AZO,KMX,AN,SAH,PAG,TSCO,ULTA,YUM,DPZ,CMG,MGM,LVS,WYNN,PENN,CZR,RSG,AWK,PCAR,ALB,FCX,NEM,GOLD,AA,CLF,STLD,NUE,RS,X,MT,CE,LYB,DOW,EMN,APTV,F,LCID,RIVN,FSR,NIO,XPEV,LI,HMC,TM,POR,OGE,NRG,AES,ET,EPD,MPLX,PAA,KMI,WMB,OKE,ENB,TRP,EXAS,IQV,CTLT,CRL,INCY,ALNY,NBIX,UTHR,BMRN,SRPT,FOLD,PTCT,RARE,BLUE,EDIT,NTLA,CRSP,BEAM,AMED,SEM,HCA,UHS,CNC,MOH,ELV,MDGL,AXSM,GH,PACB,TXG,VCYT,NTRA,CDNA,MYGN,BTX,OMCL,CERS,TRMB,GRMN,IRDM,VSAT,ASTS,PLTR,SOUN,AI,BBAI,UPST,AFRM,SOFI,HOOD,COIN,MSTR,RIOT,MARA,CLSK,ONTO,FORM,ASML,TSM,UMC,SMCI,MPWR,MCHP,SWKS,QRVO,ENTG,OLED,IPGP,SEDG,ENPH,CSIQ,FSLR,ARRY,NEP,BEP,BEPC,PLUG,BLDP,FCEL,CHPT,EVGO,QS,FREY,ALGM,ON,STM,NXPI,INFY,WIT,CTSH,EPAM,DXC,TCS,SAP,ADSK,ANSS,PTC,SSNC,TYL,MANH,APPF,WK,BL,SMAR,PSTG,NTNX,VMW,LOGI,SONY,EA,TTWO,MTCH,BMBL,SPCE,RKLB,ASTR,MAXR,PL,JOBY,ACHR,EH'.split(',');

        // CAP Stock List - Large Cap Focus (blue chips + growth)
        const CAP_STOCK_LIST = [...new Set('AAPL,MSFT,NVDA,GOOGL,GOOG,AMZN,META,BRK.A,BRK.B,LLY,AVGO,TSLA,JPM,V,UNH,XOM,MA,JNJ,HD,COST,PG,ABBV,MRK,ORCL,CRM,KO,PEP,ADBE,WMT,NFLX,AMD,LIN,CSCO,ACN,MCD,TMO,INTU,DIS,NKE,ABT,CVX,TXN,AMGN,IBM,PM,UPS,LOW,NEE,RTX,MS,GS,SPGI,BLK,ISRG,QCOM,CAT,DE,SBUX,EL,PLD,MDT,AMAT,ADI,LMT,GE,AXP,CB,MMC,CI,MO,BDX,ZTS,ICE,DUK,SO,EQIX,SHW,ITW,PNC,APD,GM,FDX,HUM,AON,EMR,ECL,ETN,EW,ROP,TRV,VRTX,PSA,NSC,PH,SLB,MCO,ORLY,GILD,REGN,BIIB,MRNA,KLAC,LRCX,CDNS,SNPS,FTNT,ADP,PAYX,CTAS,ROST,ODFL,EXC,XEL,WM,CSX,KMB,COF,MSI,ILMN,DXCM,IDXX,FAST,KR,PPG,ALL,PRU,AIG,STZ,PEG,WEC,ED,ES,HPQ,DELL,HPE,ANET,NET,DDOG,SNOW,CRWD,ZS,PANW,TEAM,HUBS,SHOP,EBAY,ETSY,PINS,ROKU,SPOT,UBER,DASH,ABNB,BKNG,EXPE,MAR,HLT,RCL,CCL,NCLH,UAL,DAL,AAL,LUV,ALK,BA,GD,NOC,LHX,TDG,URI,ULTA,YUM,DPZ,CMG,MGM,LVS,WYNN,RSG,AWK,PCAR,CUMM,ALB,FCX,NEM,AA,STLD,NUE,CE,LYB,DOW,EMN,APTV,F,ROK,KEYS,AME,IR,XYL,TT,WAB,EFX,MTB,HBAN,RF,TFC,CFG,STT,NTRS,BK,AMP,IVZ,DFS,SYF,COIN,MSTR,RIOT,MARA,CHTR,CMCSA,VZ,T,TMUS,OKTA,WDAY,NOW,SQ,PYPL,INTC,TSM,ASML,MPWR,MCHP,SWKS,QRVO,ENTG,OLED,IPGP,SEDG,ENPH,FSLR,PLUG,BLDP,CHPT,QS,ON,STM,NXPI,INFY,CTSH,EPAM,DXC,ADSK,ANSS,PTC,SSNC,TYL,MANH,APPF,SMAR,PSTG,NTNX,VMW,LOGI,EA,TTWO,MTCH,BMBL,PLTR,AI,UPST,AFRM,SOFI,HOOD,CLS,ONTO,FORM,SMCI,GRMN,TRMB,IRDM,VSAT,ASTS,RKLB,JOBY,ACHR,PL,MAXR,SPCE'.split(','))];

        // Fetch stocks from Widesurf API via backend proxy (avoids CORS issues)
        async function fetchWidesurfStocks(keyword) {
            log(`üì° Fetching ${keyword} stocks from Widesurf API...`, 'info');

            try {
                // Use backend proxy to avoid CORS issues
                const response = await fetch(`/api/widesurf/tickers/${keyword}`);
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'API request failed');
                }

                log(`‚úÖ Fetched ${data.count} stocks from Widesurf API`, 'success');
                return data.stocks;
            } catch (error) {
                log(`‚ùå Failed to fetch ${keyword} stocks: ${error.message}`, 'error');
                throw error;
            }
        }

        // Track active job IDs and per-run completion state
        let activeJobIds = [];
        let optimizationStopped = false;
        let finalizedSymbols = new Set();
        let hasJobProgressUpdates = false;

        async function stopOptimization() {
            if (activeJobIds.length === 0) {
                log('No active optimization to stop', 'warning');
                return;
            }

            optimizationStopped = true;
            log('üõë Stopping optimization...', 'warning');

            try {
                const resp = await fetch('/api/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_ids: activeJobIds })
                });

                const data = await resp.json();
                log(`‚úÖ Optimization stopped: ${data.message || 'Cancelled'}`, 'info');

                // Reset UI
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').textContent = 'Start Optimization';
                document.getElementById('global-progress').style.display = 'none';
                activeJobIds = [];
                optimizationStopped = false;

            } catch (e) {
                log(`Failed to stop: ${e.message}`, 'error');
            }
        }

        async function startOptimization(isPartial = false) {
            let symbolsInput = document.getElementById('symbols').value.trim().toUpperCase();

            // Expand keywords to stock lists
            let symbols;
            if (symbolsInput === 'ALL') {
                symbols = SPY_500_STOCKS;
                log(`Expanding 'ALL' to ${symbols.length} SPY 500 stocks...`, 'info');
            } else if (symbolsInput === 'FULL') {
                symbols = FULL_STOCK_LIST;
                log(`Expanding 'FULL' to ${symbols.length} extended sector stocks...`, 'info');
            } else if (symbolsInput === 'CAP') {
                symbols = CAP_STOCK_LIST;
                log(`Expanding 'CAP' to ${symbols.length} large cap stocks...`, 'info');
            } else if (['SPY500', 'NASDAQ500', '1000', '10000'].includes(symbolsInput)) {
                // Fetch stocks from Widesurf API
                try {
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('partial-btn').disabled = true;
                    document.getElementById('start-btn').textContent = 'Fetching stocks...';
                    symbols = await fetchWidesurfStocks(symbolsInput);
                    if (!symbols || symbols.length === 0) {
                        log(`‚ùå No stocks returned from API for ${symbolsInput}`, 'error');
                        document.getElementById('start-btn').disabled = false;
                        document.getElementById('partial-btn').disabled = false;
                        document.getElementById('start-btn').textContent = 'Start Optimization';
                        return;
                    }
                } catch (error) {
                    log(`‚ùå Failed to fetch stocks for ${symbolsInput}: ${error.message}`, 'error');
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('partial-btn').disabled = false;
                    document.getElementById('start-btn').textContent = 'Start Optimization';
                    return;
                }
            } else {
                symbols = symbolsInput.split(',').map(s => s.trim()).filter(s => s);
            }

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const capital = parseFloat(document.getElementById('capital').value);
            const trials = parseInt(document.getElementById('trials').value);
            const metric = document.getElementById('metric').value;
            const useGpu = document.getElementById('use-gpu').checked;
            const smartTiming = document.getElementById('smart-timing').checked;
            const timingApproach = document.getElementById('timing-approach').value;

            if (!symbols.length) {
                log('Please enter at least one symbol, "ALL" for SPY 500, "FULL" for extended list, or use API keywords (SPY500, NASDAQ500, 1000, 10000)', 'error');
                return;
            }

            // Save config before starting
            saveConfig();

            // Clear previous results
            document.getElementById('results').innerHTML = '';

            // Initialize and show global progress bar
            showGlobalProgress(symbols, trials);
            finalizedSymbols = new Set();
            hasJobProgressUpdates = false;

            // Show GPU mode in log
            if (useGpu) {
                log('Preparing GPU-accelerated optimization (RTX 3089 EVGA)...', 'info');
            }

            document.getElementById('start-btn').disabled = true;
            document.getElementById('partial-btn').disabled = true;
            document.getElementById('start-btn').textContent = 'Optimizing...';
            if (isPartial) {
                document.getElementById('partial-btn').textContent = 'Checking stocks...';
            }

            log(`${isPartial ? 'Partial' : 'Full'} optimization started for: ${symbols.join(', ')}`, 'info');

            try {
                const algo = document.getElementById('algo-select').value;
                const backtestStart = document.getElementById('backtest-start-date').value;
                const backtestEnd = document.getElementById('backtest-end-date').value;
                const resp = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbols,
                        start_date: startDate,
                        end_date: endDate,
                        backtest_start_date: backtestStart || null,
                        backtest_end_date: backtestEnd || null,
                        capital,
                        n_trials: trials,
                        optimization_metric: metric,
                        use_gpu: useGpu,
                        smart_timing: smartTiming,
                        timing_approach: timingApproach,
                        algo: algo,
                        data_source: document.getElementById('data-source').value,
                        partial: isPartial
                    })
                });

                const data = await resp.json();
                if (data.job_id) {
                    activeJobIds.push(data.job_id);
                }
                log(`Job started: ${data.job_id}`, 'info');

                // If all stocks skipped, reset buttons
                if (data.status === 'completed' && data.symbols && data.symbols.length === 0) {
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('partial-btn').disabled = false;
                    document.getElementById('start-btn').textContent = 'Start Optimization';
                    document.getElementById('partial-btn').textContent = 'üß© Partial Optimization';
                }
            } catch (e) {
                log(`Failed to start: ${e.message}`, 'error');
                document.getElementById('start-btn').disabled = false;
                document.getElementById('partial-btn').disabled = false;
                document.getElementById('start-btn').textContent = 'Start Optimization';
                document.getElementById('partial-btn').textContent = 'üß© Partial Optimization';
            }
        }

        // Toggle timing approach visibility
        function toggleTimingApproach() {
            const smartTimingChecked = document.getElementById('smart-timing').checked;
            const approachGroup = document.getElementById('timing-approach-group');
            approachGroup.style.display = smartTimingChecked ? 'block' : 'none';
        }

        // Add event listener for smart timing checkbox
        document.getElementById('smart-timing').addEventListener('change', toggleTimingApproach);

        const TIMING_DESCRIPTIONS = {
            sequential: "‚ö° <strong>Sequential (Faster)</strong><br>First finds the best buy/sell trigger %, then separately optimizes the ideal time of day to enter. About 30 seconds faster overall. Best for quick scans.",
            joint: "üéØ <strong>Joint (Better Results)</strong><br>Optimizes buy trigger, sell trigger, AND entry time all together simultaneously. Explores more combinations ‚Äî may find better parameters but takes longer."
        };

        function updateTimingDescription() {
            const val = document.getElementById('timing-approach').value;
            const el = document.getElementById('timing-description');
            if (el) el.innerHTML = TIMING_DESCRIPTIONS[val] || '';
        }

        // Call on load to show default description when timing panel is visible
        document.addEventListener('DOMContentLoaded', function () {
            updateTimingDescription();
        });

        async function loadApiKeys() {
            try {
                const response = await fetch('/api/keys');
                const data = await response.json();

                if (data.success) {
                    const keys = data.keys;
                    if (keys.ALPACA) {
                        document.getElementById('api-key-alpaca-id').value = keys.ALPACA.key_id || '';
                        document.getElementById('api-key-alpaca-secret').value = keys.ALPACA.secret_key || '';
                        document.getElementById('api-key-alpaca-url').value = keys.ALPACA.base_url || '';
                    }
                    if (keys.MASSIVE) {
                        document.getElementById('api-key-massive-secret').value = keys.MASSIVE.secret_key || '';
                        document.getElementById('api-key-massive-url').value = keys.MASSIVE.base_url || '';
                    }
                    if (keys.WIDESURF) {
                        document.getElementById('api-key-widesurf-secret').value = keys.WIDESURF.secret_key || '';
                        document.getElementById('api-key-widesurf-url').value = keys.WIDESURF.base_url || '';
                    }
                }
            } catch (error) {
                console.error('Failed to load API keys:', error);
            }
        }

        async function saveApiKeys() {
            const statusDiv = document.getElementById('api-keys-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(255, 255, 255, 0.1)';
            statusDiv.innerHTML = 'Saving...';
            statusDiv.style.color = 'var(--text-secondary)';

            const keys = {
                ALPACA: {
                    key_id: document.getElementById('api-key-alpaca-id').value,
                    secret_key: document.getElementById('api-key-alpaca-secret').value,
                    base_url: document.getElementById('api-key-alpaca-url').value
                },
                MASSIVE: {
                    secret_key: document.getElementById('api-key-massive-secret').value,
                    base_url: document.getElementById('api-key-massive-url').value
                },
                WIDESURF: {
                    secret_key: document.getElementById('api-key-widesurf-secret').value,
                    base_url: document.getElementById('api-key-widesurf-url').value
                }
            };

            try {
                const response = await fetch('/api/keys', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys })
                });
                const data = await response.json();

                if (data.success) {
                    statusDiv.style.background = 'rgba(72, 187, 120, 0.1)';
                    statusDiv.style.color = '#48bb78';
                    statusDiv.innerHTML = '‚úÖ API Keys saved successfully!';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                        loadApiKeys(); // Reload to get masked values
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                statusDiv.style.background = 'rgba(245, 101, 101, 0.1)';
                statusDiv.style.color = '#f56565';
                statusDiv.innerHTML = '‚ùå Failed to save API keys: ' + error.message;
            }
        }

        // Initialize
        loadConfig();
        loadApiKeys();
        setupConfigAutoSave();
        connectWebSocket();
        loadHistory();
    </script>
</body>

</html>
